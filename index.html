<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Food Matrix</title>
Â  Â  Â  Â  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŒ¿</text></svg>">
Â  Â  Â  Â  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
Â  Â  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
Â  Â  Â  Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
Â  Â  <style>
Â  Â  Â  Â  /* Modern Color Palette and Variables (AI-Enhanced Design) */
Â  Â  Â  Â  :root {
Â  Â  Â  Â  Â  Â  /* UPDATED: A deeper, more modern Indigo/Blue */
Â  Â  Â  Â  Â  Â  --primary-color: #4F46E5; /* Indigo 600 */
Â  Â  Â  Â  Â  Â  --primary-light: #6366F1; /* Indigo 500 (for hovers) */
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  --bg-color: #F9FAFB; /* Softer background (Gray 50) */
Â  Â  Â  Â  Â  Â  --text-color: #111827; /* Darker text (Gray 900) */
Â  Â  Â  Â  Â  Â  --text-light: #6B7280;
Â  Â  Â  Â  Â  Â  --card-bg: white;
Â  Â  Â  Â  Â  Â  --input-bg: #F3F4F6; /* Slightly darker input bg (Gray 100) */
Â  Â  Â  Â  Â  Â  --border-color: #E5E7EB;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  /* UPDATED: Softer, layered shadows for depth */
Â  Â  Â  Â  Â  Â  --shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
Â  Â  Â  Â  Â  Â  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);

Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  /* Define colors for sections/icons - using a harmonious palette */
Â  Â  Â  Â  Â  Â  --color-overview: #4B5563;
Â  Â  Â  Â  Â  Â  --color-nutrition: #10B981; /* Emerald */
Â  Â  Â  Â  Â  Â  --color-bioactives: #06B6D4; /* Cyan */
Â  Â  Â  Â  Â  Â  --color-usage: #F59E0B;Â  Â  Â /* Amber */
Â  Â  Â  Â  Â  Â  --color-metabolic: #8B5CF6;Â  /* Violet */
Â  Â  Â  Â  Â  Â  --color-tradition: #A16207;Â  /* Brown/Yellow (Fermentation) */
Â  Â  Â  Â  Â  Â  --color-herbal: #14B8A6;Â  Â  /* Teal */
Â  Â  Â  Â  Â  Â  --color-notes: #64748B;
Â  Â  Â  Â  Â  Â  --color-references: #94A3B8;

            /* NEW: Basis specific colors as requested */
            --color-basis-research: #006400; /* Dark Green */
Â  Â  Â  Â  Â  Â  --color-basis-book: #A52A2A; Â  Â /* Brown */
Â  Â  Â  Â  Â  Â  --color-basis-gen: #00008B; Â  Â  /* Dark Blue */
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  --current-active-color: var(--color-overview);
Â  Â  Â  Â  Â  Â  --current-page-bg: color-mix(in srgb, var(--current-active-color) 8%, white);
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Base Styles */
Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
Â  Â  Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  Â  Â  padding: 0;
Â  Â  Â  Â  Â  Â  background-color: var(--bg-color);
Â  Â  Â  Â  Â  Â  color: var(--text-color);
Â  Â  Â  Â  Â  Â  line-height: 1.6;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Header Styles */
Â  Â  Â  Â  header {
Â  Â  Â  Â  Â  Â  background-color: var(--primary-color);
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  padding: 0.8rem 1rem;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
Â  Â  Â  Â  Â  Â  position: sticky;
Â  Â  Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  Â  Â  z-index: 20;
Â  Â  Â  Â  }

Â  Â  Â  Â  .header-left {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  gap: 12px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* UPDATED: Class for the custom SVG icon */
Â  Â  Â  Â  .header-app-icon {
Â  Â  Â  Â  Â  Â  width: 32px; /* Slightly larger for better definition */
Â  Â  Â  Â  Â  Â  height: 32px;
Â  Â  Â  Â  Â  Â  display: block; /* Ensures proper alignment */
Â  Â  Â  Â  }

Â  Â  Â  Â  .header-icon {
Â  Â  Â  Â  Â  Â  Â font-size: 28px;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Stylish Title with Gradient */
Â  Â  Â  Â  .header-title {
Â  Â  Â  Â  Â  Â  font-size: 1.3rem;
Â  Â  Â  Â  Â  Â  font-weight: 800; /* Extra bold */
Â  Â  Â  Â  Â  Â  letter-spacing: 0.5px;
Â  Â  Â  Â  Â  Â  color: white; /* Fallback color */
Â  Â  Â  Â  Â  Â  text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Modern browser enhancement for gradient text */
Â  Â  Â  Â  @supports (-webkit-background-clip: text) or (background-clip: text) {
Â  Â  Â  Â  Â  Â  .header-title {
Â  Â  Â  Â  Â  Â  Â  Â  /* Gradient from white to a very light indigo tint */
Â  Â  Â  Â  Â  Â  Â  Â  background: linear-gradient(to right, #ffffff 0%, #E0E7FF 100%);
Â  Â  Â  Â  Â  Â  Â  Â  -webkit-background-clip: text;
Â  Â  Â  Â  Â  Â  Â  Â  background-clip: text;
Â  Â  Â  Â  Â  Â  Â  Â  color: transparent;
Â  Â  Â  Â  Â  Â  Â  Â  display: inline-block;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Camera Button */
Â  Â  Â  Â  .camera-button {
Â  Â  Â  Â  Â  Â  background: none;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  padding: 8px;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  transition: background-color 0.2s;
Â  Â  Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .camera-button:hover {
Â  Â  Â  Â  Â  Â  background-color: rgba(255, 255, 255, 0.2);
Â  Â  Â  Â  }

Â  Â  Â  Â  .camera-button:disabled {
Â  Â  Â  Â  Â  Â  opacity: 0.5;
Â  Â  Â  Â  Â  Â  cursor: not-allowed;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Selection Panel (Hidden on Mobile) */
Â  Â  Â  Â  .selection-panel {
Â  Â  Â  Â  Â  Â  display: none; /* Hidden by default (mobile-first) */
Â  Â  Â  Â  Â  Â  gap: 8px;
Â  Â  Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  Â  Â  background-color: var(--card-bg);
Â  Â  Â  Â  Â  Â  box-shadow: var(--shadow);
Â  Â  Â  Â  Â  Â  /* Positioned below the sticky header on desktop */
Â  Â  Â  Â  Â  Â  position: sticky;
Â  Â  Â  Â  Â  Â  top: 62px; /* Adjust based on header height */
Â  Â  Â  Â  Â  Â  z-index: 10;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Dropdowns (Used in Panel and Modal) */
Â  Â  Â  Â  .select-wrapper {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  flex-grow: 1;
Â  Â  Â  Â  Â  Â  border: 1px solid var(--border-color);
Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  padding-left: 8px;
Â  Â  Â  Â  Â  Â  background-color: var(--input-bg);Â Â 
Â  Â  Â  Â  Â  Â  transition: border-color 0.3s;
Â  Â  Â  Â  Â  Â  min-width: 0;Â Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  .select-wrapper:focus-within {
Â  Â  Â  Â  Â  Â  border-color: var(--primary-color);
Â  Â  Â  Â  }

Â  Â  Â  Â  .select-wrapper .material-icons {
Â  Â  Â  Â  Â  Â  color: var(--text-light);
Â  Â  Â  Â  Â  Â  font-size: 22px;
Â  Â  Â  Â  }

Â  Â  Â  Â  select {
Â  Â  Â  Â  Â  Â  padding: 10px 4px;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  background: transparent;
Â  Â  Â  Â  Â  Â  flex-grow: 1;
Â  Â  Â  Â  Â  Â  min-width: 0;Â Â 
Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  Â  Â  appearance: none;
Â  Â  Â  Â  Â  Â  font-family: inherit;
Â  Â  Â  Â  Â  Â  color: var(--text-color);
Â  Â  Â  Â  Â  Â  outline: none;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- Mobile Floating Action Button (FAB) --- */
Â  Â  Â  Â  #mobile-fab {
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  bottom: 20px;
Â  Â  Â  Â  Â  Â  right: 20px;
Â  Â  Â  Â  Â  Â  background-color: var(--primary-color);
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  border-radius: 50px; /* Pill shape */
Â  Â  Â  Â  Â  Â  padding: 15px 25px;
Â  Â  Â  Â  Â  Â  Â /* UPDATED: Using a standard, more subtle shadow */
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  z-index: 100;
Â  Â  Â  Â  Â  Â  font-family: inherit;
Â  Â  Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  Â  Â  font-size: 1rem;
Â  Â  Â  Â  Â  Â  transition: transform 0.2s, box-shadow 0.2s, background-color 0.2s;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  gap: 8px;
Â  Â  Â  Â  }

Â  Â  Â  Â  #mobile-fab:hover {
Â  Â  Â  Â  Â  Â  transform: translateY(-3px);
Â  Â  Â  Â  Â  Â  /* UPDATED: Subtle shadow on hover */
Â  Â  Â  Â  Â  Â  box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
Â  Â  Â  Â  Â  Â  background-color: var(--primary-light);
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- Selection Modal (Mobile) --- */
Â  Â  Â  Â  #selection-modal {
Â  Â  Â  Â  Â  Â  display: none; /* Handled by JS */
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  Â  Â  background-color: rgba(0, 0, 0, 0.6);
Â  Â  Â  Â  Â  Â  z-index: 1000;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  }

Â  Â  Â  Â  .selection-modal-content {
Â  Â  Â  Â  Â  Â  background-color: white;
Â  Â  Â  Â  Â  Â  padding: 30px;
Â  Â  Â  Â  Â  Â  border-radius: 16px;
Â  Â  Â  Â  Â  Â  box-shadow: var(--shadow-lg);
Â  Â  Â  Â  Â  Â  width: 90%;
Â  Â  Â  Â  Â  Â  max-width: 400px;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  gap: 20px;
Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  }

Â  Â  Â  Â  .selection-modal-title {
Â  Â  Â  Â  Â  Â  font-size: 1.4rem;
Â  Â  Â  Â  Â  Â  font-weight: 700;
Â  Â  Â  Â  Â  Â  color: var(--text-color);
Â  Â  Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  }

Â  Â  Â  Â  .modal-close {
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  top: 15px;
Â  Â  Â  Â  Â  Â  right: 15px;
Â  Â  Â  Â  Â  Â  background: none;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  font-size: 24px;
Â  Â  Â  Â  Â  Â  color: var(--text-light);
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  }


Â  Â  Â  Â  /* Main Container */
Â  Â  Â  Â  .container {
Â  Â  Â  Â  Â  Â  padding: 20px 15px;
Â  Â  Â  Â  Â  Â  max-width: 800px;
Â  Â  Â  Â  Â  Â  margin: auto;
Â  Â  Â  Â  Â  Â  /* Added padding bottom for FAB clearance */
Â  Â  Â  Â  Â  Â  padding-bottom: 100px;
Â  Â  Â  Â  }

Â  Â  Â  Â  #food-title {
Â  Â  Â  Â  Â  Â  font-size: 1.75rem;
Â  Â  Â  Â  Â  Â  font-weight: 700;
Â  Â  Â  Â  Â  Â  /* Adjusted margin to account for new icon row styling */
Â  Â  Â  Â  Â  Â  margin-top: 25px;Â Â 
Â  Â  Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  color: var(--text-color);
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Icon Button Row (UPDATED: Modernized) */
Â  Â  Â  Â  .icon-row {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-wrap: nowrap;
Â  Â  Â  Â  Â  Â  overflow-x: auto;
Â  Â  Â  Â  Â  Â  -webkit-overflow-scrolling: touch;
Â  Â  Â  Â  Â  Â  gap: 12px; /* Slightly larger gap */
Â  Â  Â  Â  Â  Â  justify-content: flex-start;
Â  Â  Â  Â  Â  Â  padding: 10px 0; /* Padding removed from the container */
Â  Â  Â  Â  Â  Â  background: transparent; /* Removed background card styling */
Â  Â  Â  Â  Â  Â  box-shadow: none; /* Removed shadow */
Â  Â  Â  Â  Â  Â  border-radius: 0;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Hide scrollbar */
Â  Â  Â  Â  .icon-row::-webkit-scrollbar { display: none; }
Â  Â  Â  Â  .icon-row { -ms-overflow-style: none; scrollbar-width: none; }

Â  Â  Â  Â  /* Icon Buttons (UPDATED: Modernized) */
Â  Â  Â  Â  .icon-button {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  /* Increased size slightly for better tap target */
Â  Â  Â  Â  Â  Â  width: 55px;Â Â 
Â  Â  Â  Â  Â  Â  height: 55px;
Â  Â  Â  Â  Â  Â  min-width: 55px;
Â  Â  Â  Â  Â  Â  min-height: 55px;
Â  Â  Â  Â  Â  Â  flex-shrink: 0;
Â  Â  Â  Â  Â  Â  border-radius: 16px; /* More rounded */
Â  Â  Â  Â  Â  Â  border: none; /* Removed border */
Â  Â  Â  Â  Â  Â  background-color: var(--card-bg); /* White background */
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  Â  Â  Â  color: var(--text-light);
Â  Â  Â  Â  Â  Â  box-shadow: var(--shadow); /* Individual shadow */
Â  Â  Â  Â  }

Â  Â  Â  Â  .icon-button .material-icons {
Â  Â  Â  Â  Â  Â  font-size: 28px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .icon-button:hover {
Â  Â  Â  Â  Â  Â  transform: translateY(-3px);
Â  Â  Â  Â  Â  Â  box-shadow: var(--shadow-lg);
Â  Â  Â  Â  }

Â  Â  Â  Â  .icon-button.active {
Â  Â  Â  Â  Â  Â  background-color: var(--current-active-color);
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  /* Dynamic shadow color */
Â  Â  Â  Â  Â  Â  box-shadow: 0 6px 15px color-mix(in srgb, var(--current-active-color) 30%, transparent);
Â  Â  Â  Â  }


Â  Â  Â  Â  /* Tabs Layout (Card) */
Â  Â  Â  Â  .tabs-container {
Â  Â  Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  Â  Â  box-shadow: var(--shadow-lg);
Â  Â  Â  Â  Â  Â  background-color: var(--current-page-bg);
Â  Â  Â  Â  Â  Â  transition: background-color 0.5s;
Â  Â  Â  Â  Â  Â  margin-bottom: 25px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .tabs-header {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  /* Use a slightly darker grey for the tab header */
Â  Â  Â  Â  Â  Â  background-color: #EAECEF;Â Â 
Â  Â  Â  Â  Â  Â  border-radius: 12px 12px 0 0;
Â  Â  Â  Â  }

Â  Â  Â  Â  .tab-button {
Â  Â  Â  Â  Â  Â  flex: 1;
Â  Â  Â  Â  Â  Â  padding: 15px;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  background-color: transparent;Â Â 
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  font-size: 1rem;
Â  Â  Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  Â  Â  color: var(--text-light);
Â  Â  Â  Â  Â  Â  transition: background-color 0.3s, color 0.3s;
Â  Â  Â  Â  Â  Â  font-family: inherit;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  #tab-btn-overview.active { border-radius: 12px 0 0 0; }
Â  Â  Â  Â  #tab-btn-dynamic.active { border-radius: 0 12px 0 0; }

Â  Â  Â  Â  .tab-button.active {
Â  Â  Â  Â  Â  Â  background-color: var(--current-active-color);
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  transition: background-color 0.5s, color 0.5s;
Â  Â  Â  Â  }

Â  Â  Â  Â  .tab-content {
Â  Â  Â  Â  Â  Â  display: none;
Â  Â  Â  Â  Â  Â  padding: 25px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .tab-content.active {
Â  Â  Â  Â  Â  Â  display: block;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Info Sections */
Â  Â  Â  Â  .info-section {
Â  Â  Â  Â  Â  Â  margin-bottom: 25px;
Â  Â  Â  Â  Â  Â  Â padding-bottom: 20px;
Â  Â  Â  Â  Â  Â  border-bottom: 1px solid var(--border-color);
Â  Â  Â  Â  }

Â  Â  Â  Â  .info-section:last-child {
Â  Â  Â  Â  Â  Â  margin-bottom: 0;
Â  Â  Â  Â  Â  Â  border-bottom: none;
Â  Â  Â  Â  Â  Â  padding-bottom: 0;
Â  Â  Â  Â  }

Â  Â  Â  Â  .info-title {
Â  Â  Â  Â  Â  Â  font-weight: 700;
Â  Â  Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  Â  Â  Â  font-size: 1.15rem;
Â  Â  Â  Â  Â  Â  color: var(--current-active-color);
Â  Â  Â  Â  Â  Â  transition: color 0.5s;
Â  Â  Â  Â  }

Â  Â  Â  Â  .info-content {
Â  Â  Â  Â  Â  Â  white-space: pre-wrap;
Â  Â  Â  Â  Â  Â  font-size: 0.95rem;
Â  Â  Â  Â  }

Â  Â  Â  Â  .no-data {
Â  Â  Â  Â  Â  Â  color: var(--text-light);
Â  Â  Â  Â  Â  Â  font-style: italic;
Â  Â  Â  Â  }

Â  Â  Â  Â  a {
            /* Ensure links stand out even within colored text */
Â  Â  Â  Â  Â  Â  color: var(--primary-color);
Â  Â  Â  Â  Â  Â  text-decoration: none;
Â  Â  Â  Â  Â  Â  font-weight: 600;
            /* Adding a subtle background can help visibility on colored spans */
            background-color: rgba(79, 70, 229, 0.1); 
            padding: 0 2px;
            border-radius: 3px;
Â  Â  Â  Â  }

Â  Â  Â  Â  a:hover {
Â  Â  Â  Â  Â  Â  text-decoration: underline;
            background-color: rgba(79, 70, 229, 0.2); 
Â  Â  Â  Â  }

Â  Â  Â  Â  #loading {
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  padding: 50px;
Â  Â  Â  Â  Â  Â  font-size: 1.2rem;
Â  Â  Â  Â  Â  Â  color: var(--text-light);
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Image Container */
Â  Â  Â  Â  #image-container {
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  margin-bottom: 25px;
Â  Â  Â  Â  Â  Â  background: var(--card-bg);
Â  Â  Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  Â  Â  box-shadow: var(--shadow);
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  #food-image {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  max-height: 250px;Â Â 
Â  Â  Â  Â  Â  Â  object-fit: cover;
Â  Â  Â  Â  Â  Â  display: block;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  #image-placeholder-text {
Â  Â  Â  Â  Â  Â  padding: 50px;
Â  Â  Â  Â  Â  Â  color: var(--text-light);
Â  Â  Â  Â  Â  Â  font-style: italic;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- AI Feature Styles --- */

Â  Â  Â  Â  .ai-button {
Â  Â  Â  Â  Â  Â  background-color: var(--primary-color);
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  padding: 10px 15px;
Â  Â  Â  Â  Â  Â  font-family: inherit;
Â  Â  Â  Â  Â  Â  font-size: 0.9rem;
Â  Â  Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  transition: background-color 0.2s, box-shadow 0.2s;
Â  Â  Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .ai-button:hover {
Â  Â  Â  Â  Â  Â  background-color: var(--primary-light);
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 10px color-mix(in srgb, var(--primary-color) 40%, transparent);
Â  Â  Â  Â  }

Â  Â  Â  Â  .ai-button:disabled {
Â  Â  Â  Â  Â  Â  background-color: #B0B0B0;
Â  Â  Â  Â  Â  Â  cursor: not-allowed;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* NEW: AI Summary Card (Moved to bottom) */
Â  Â  Â  Â  .summary-card {
Â  Â  Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  Â  Â  box-shadow: var(--shadow-lg);
Â  Â  Â  Â  Â  Â  background-color: var(--card-bg); /* Use white bg */
Â  Â  Â  Â  Â  Â  padding: 25px;
Â  Â  Â  Â  Â  Â  margin-top: 25px; /* Add space above it */
Â  Â  Â  Â  }

Â  Â  Â  Â  .summary-card .info-title {
Â  Â  Â  Â  Â  Â  color: var(--primary-color); /* Make title stand out */
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Loading Modal (AI Processing) */
Â  Â  Â  Â  .modal-overlay {
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  Â  Â  background-color: rgba(0, 0, 0, 0.6);
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  z-index: 1000;
Â  Â  Â  Â  }

Â  Â  Â  Â  .modal-content {
Â  Â  Â  Â  Â  Â  background-color: white;
Â  Â  Â  Â  Â  Â  padding: 25px;
Â  Â  Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  Â  Â  box-shadow: var(--shadow-lg);
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  max-width: 350px; /* Increased slightly for better feedback */
Â  Â  Â  Â  Â  Â  width: 80%;
Â  Â  Â  Â  }

Â  Â  Â  Â  .modal-content p {
Â  Â  Â  Â  Â  Â  font-size: 1rem;
Â  Â  Â  Â  Â  Â  color: var(--text-color);
Â  Â  Â  Â  Â  Â  margin: 0;
            white-space: pre-wrap; /* Ensure line breaks in modal messages are respected */
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Simple CSS Spinner */
Â  Â  Â  Â  .spinner {
Â  Â  Â  Â  Â  Â  border: 4px solid var(--input-bg);
Â  Â  Â  Â  Â  Â  border-top: 4px solid var(--primary-color);
Â  Â  Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  Â  Â  width: 30px;
Â  Â  Â  Â  Â  Â  height: 30px;
Â  Â  Â  Â  Â  Â  animation: spin 1s linear infinite;
Â  Â  Â  Â  Â  Â  margin: 0 auto 15px auto;
Â  Â  Â  Â  }

Â  Â  Â  Â  @keyframes spin {
Â  Â  Â  Â  Â  Â  0% { transform: rotate(0deg); }
Â  Â  Â  Â  Â  Â  100% { transform: rotate(360deg); }
Â  Â  Â  Â  }


Â  Â  Â  Â  /* Responsive adjustments for larger screens (Desktop View) */
Â  Â  Â  Â  @media (min-width: 600px) {
Â  Â  Â  Â  Â  Â  /* Show the selection panel on desktop */
Â  Â  Â  Â  Â  Â  .selection-panel {
Â  Â  Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  /* Hide the mobile FAB and Modal on desktop */
Â  Â  Â  Â  Â  Â  #mobile-fab {
Â  Â  Â  Â  Â  Â  Â  Â  display: none;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  #selection-modal {
Â  Â  Â  Â  Â  Â  Â  Â  display: none !important;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  /* Revert icon-row to centered wrapping on larger screens */
Â  Â  Â  Â  Â  Â  .icon-row {
Â  Â  Â  Â  Â  Â  Â  Â  flex-wrap: wrap;
Â  Â  Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  Â  Â  overflow-x: visible;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .icon-button {
Â  Â  Â  Â  Â  Â  Â  Â  width: 65px;
Â  Â  Â  Â  Â  Â  Â  Â  height: 65px;
Â  Â  Â  Â  Â  Â  Â  Â  min-width: 65px;
Â  Â  Â  Â  Â  Â  Â  Â  min-height: 65px;
Â  Â  Â  Â  Â  Â  Â  Â  border-radius: 18px;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  .icon-button .material-icons {
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 32px;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  select {
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 15px;
Â  Â  Â  Â  Â  Â  Â  Â  padding: 12px 8px;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â header {
Â  Â  Â  Â  Â  Â  Â  Â  Â padding: 1rem;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  #food-image {
Â  Â  Â  Â  Â  Â  Â  Â  max-height: 350px;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  .select-wrapper .material-icons {
Â  Â  Â  Â  Â  Â  Â  Â  Â font-size: 24px;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  .container {
Â  Â  Â  Â  Â  Â  Â  Â  /* Remove extra bottom padding on desktop */
Â  Â  Â  Â  Â  Â  Â  Â  padding-bottom: 20px;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  </style>
</head>
<body>

<header>
Â  Â  <div class="header-left">
Â  Â  Â  Â  ```svg
Â  Â  Â  Â  <svg class="header-app-icon" viewBox="0 0 100 100" xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)">
Â  Â  Â  Â  Â  Â  <style>
Â  Â  Â  Â  Â  Â  Â  Â  /* Styles defined within SVG for portability */
Â  Â  Â  Â  Â  Â  Â  Â  .icon-fill { fill: white; }
Â  Â  Â  Â  Â  Â  Â  Â  /* Light indigo/lavender accent matching the theme */
Â  Â  Â  Â  Â  Â  Â  Â  .icon-accent { fill: #A5B4FC; }Â 
Â  Â  Â  Â  Â  Â  </style>
Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path d="M20 55 C20 75 35 90 50 90 C65 90 80 75 80 55 L80 50 L20 50 Z" class="icon-fill"/>
Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path d="M55 45 L 65 30 C 70 25 70 15 60 15 C 50 15 50 25 55 30 Z" class="icon-fill"/>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <rect x="15" y="88" width="70" height="4" rx="2" class="icon-accent" opacity="0.5"/>
Â  Â  Â  Â Â 
Â  Â  Â  Â  </svg>
````

Â  Â  Â  Â  \<span class="header-title"\>Food Matrix\</span\>
Â  Â  \</div\>
Â  Â Â 
Â  Â  \<button class="camera-button" title="Identify Food" onclick="triggerCamera()"\>
Â  Â  Â  Â  \<i class="material-icons header-icon"\>photo\_camera\</i\>
Â  Â  \</button\>

\</header\>

\<input type="file" id="camera-input" accept="image/\*" capture="environment" style="display: none;"\>

\<div id="ai-modal" class="modal-overlay" style="display: none;"\>
Â  Â  \<div class="modal-content"\>
Â  Â  Â  Â  \<div class="spinner" id="modal-spinner"\>\</div\>
Â  Â  Â  Â  \<p id="modal-message"\>Identifying food...\</p\>
Â  Â  Â  Â  \<button id="modal-close-btn" class="ai-button" style="display: none; margin-top: 15px;"\>Close\</button\>
Â  Â  \</div\>
\</div\>

\<div id="loading"\>Loading Food matrix data...\</div\>

\<div id="dropdowns-container" style="display: none;"\>
Â  Â  Â \<div class="select-wrapper"\>
Â  Â  Â  Â  Â \<i class="material-icons" title="Category"\>category\</i\>
Â  Â  Â  Â  Â \<select id="category-select" aria-label="Select Category"\>
Â  Â  Â  Â  Â  Â  Â \<option value=""\>Select Category...\</option\>
Â  Â  Â  Â  Â \</select\>
Â  Â  Â \</div\>
Â  Â  \<div class="select-wrapper"\>
Â  Â  Â  Â  \<i class="material-icons" title="Food Item"\>restaurant\</i\>
Â  Â  Â  Â  \<select id="food-select" aria-label="Select Food" disabled\>
Â  Â  Â  Â  Â  Â  \<option value=""\>Select Food...\</option\>
Â  Â  Â  Â  \</select\>
Â  Â  \</div\>
Â  Â  \<div class="select-wrapper" id="basis-wrapper"\>
Â  Â  Â  Â  \<i class="material-icons" title="Research Basis"\>science\</i\>
Â  Â  Â  Â  \<select id="basis-select" aria-label="Select Basis"\>
Â  Â  Â  Â  Â  Â  \<option value="All"\>All\</option\>
Â  Â  Â  Â  Â  Â  \<option value="Research"\>R (Research)\</option\>
Â  Â  Â  Â  Â  Â  \<option value="Book"\>B (Book)\</option\>
Â  Â  Â  Â  Â  Â  \<option value="Gen"\>G (Gen)\</option\>
Â  Â  Â  Â  \</select\>
Â  Â  \</div\>
\</div\>

\<div class="selection-panel" id="selection-panel"\>
Â  Â  \</div\>

\<button id="mobile-fab" onclick="openSelectionModal()"\>
Â  Â  \<i class="material-icons"\>filter\_list\</i\>
Â  Â  Select Food
\</button\>

\<div id="selection-modal"\>
Â  Â  \<div class="selection-modal-content"\>
Â  Â  Â  Â  \<button class="modal-close material-icons" onclick="closeSelectionModal()"\>close\</button\>
Â  Â  Â  Â  \<div class="selection-modal-title"\>Filter Options\</div\>
Â  Â  Â  Â  \<div id="modal-dropdowns-target"\>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  \</div\>
Â  Â  \</div\>
\</div\>

\<div class="container" id="main-content" style="display: none;"\>
Â  Â Â 
Â  Â  Â  Â  \<div class="icon-row" id="icon-row"\>
Â  Â  Â  Â  Â  Â  \</div\>

Â  Â  Â  Â  \<h2 id="food-title"\>\</h2\>

Â  Â  Â  Â  \<div class="tabs-container" id="tabs-container"\>
Â  Â  Â  Â  \<div class="tabs-header"\>
Â  Â  Â  Â  Â  Â  \<button class="tab-button active" id="tab-btn-overview" data-tab="tab-overview"\>Overview\</button\>
Â  Â  Â  Â  Â  Â  \<button class="tab-button" id="tab-btn-dynamic" data-tab="tab-dynamic"\>Details\</button\>
Â  Â  Â  Â  \</div\>
Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  \<div class="tab-content active" id="tab-overview"\>
Â  Â  Â  Â  Â  Â  \<div class="info-section"\>
Â  Â  Â  Â  Â  Â  Â  Â  \<div class="info-title"\>Specific Benefits\</div\>
Â  Â  Â  Â  Â  Â  Â  Â  \<div class="info-content" id="Specific Benefits (min 50 to max 100 words) (K)"\>\</div\>
Â  Â  Â  Â  Â  Â  \</div\>
Â  Â  Â  Â  Â  Â  \<div class="info-section"\>
Â  Â  Â  Â  Â  Â  Â  Â  \<div class="info-title"\>Health Tags\</div\>
Â  Â  Â  Â  Â  Â  Â  Â  \<div class="info-content" id="Health Tags"\>\</div\>
Â  Â  Â  Â  Â  Â  \</div\>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  \</div\>
Â  Â  Â  Â Â 
Â  Â  Â  Â  Â Â  Â  Â  Â  \<div class="tab-content" id="tab-dynamic"\>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  \</div\>
Â  Â  \</div\>
Â  Â Â 
Â  Â  Â  Â  \<div class="summary-card" id="ai-summary-section"\>
Â  Â  Â  Â  \<div class="info-title"\>âœ¨ AI Summary\</div\>
Â  Â  Â  Â  \<button id="ai-summary-btn" class="ai-button"\>Generate AI Summary\</button\>
Â  Â  Â  Â  \<div class="info-content" id="ai-summary-content"\>
Â  Â  Â  Â  Â  Â  \<p class="no-data"\>Click the button to generate an AI-powered summary of this food's benefits.\</p\>
Â  Â  Â  Â  \</div\>
Â  Â  \</div\>
Â  Â Â 
Â  Â  Â  Â  \<div id="image-container" style="display: none;"\>
Â  Â  Â  Â  \<img id="food-image" src="" alt="Food Image"\>
Â  Â  Â  Â  \<div id="image-placeholder-text" style="display: none;"\>Image not available\</div\>
Â  Â  \</div\>

\</div\>

\<script\>
Â  Â  // ES5 Compatibility Polyfill for Array.prototype.find
Â  Â  if (\!Array.prototype.find) {
Â  Â  Â  Object.defineProperty(Array.prototype, 'find', {
Â  Â  Â  Â  value: function(predicate) {
Â  Â  Â  Â  Â if (this == null) {
Â  Â  Â  Â  Â  Â throw new TypeError('"this" is null or not defined');
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â var o = Object(this);
Â  Â  Â  Â  Â var len = o.length \>\>\> 0;
Â  Â  Â  Â  Â if (typeof predicate \!== 'function') {
Â  Â  Â  Â  Â  Â throw new TypeError('predicate must be a function');
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â var thisArg = arguments[1];
Â  Â  Â  Â  Â var k = 0;
Â  Â  Â  Â  Â while (k \< len) {
Â  Â  Â  Â  Â  Â var kValue = o[k];
Â  Â  Â  Â  Â  Â if (predicate.call(thisArg, kValue, k, o)) {
Â  Â  Â  Â  Â  Â  Â return kValue;
Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â k++;
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â return undefined;
Â  Â  Â  Â  },
Â  Â  Â  Â  configurable: true,
Â  Â  Â  Â  writable: true
Â  Â  Â  });
Â  Â  }

Â  Â  // ES5 Compatibility Polyfill for Array.prototype.filter (Needed for the updated formatData function)
Â  Â  if (\!Array.prototype.filter) {
Â  Â  Â  Array.prototype.filter = function(func, thisArg) {
Â  Â  Â  Â  'use strict';
Â  Â  Â  Â  if ( \! ((typeof func === 'function') && this) )
Â  Â  Â  Â  Â  Â  throw new TypeError();
Â  Â  Â  Â Â 
Â  Â  Â  Â  var len = this.length \>\>\> 0,
Â  Â  Â  Â  Â  Â  res = new Array(len),
Â  Â  Â  Â  Â  Â  t = this, c = 0, i = -1;

Â  Â  Â  Â  if (thisArg === undefined) {
Â  Â  Â  Â  Â  while (++i \!== len) {
Â  Â  Â  Â  Â  Â  if (i in this) {
Â  Â  Â  Â  Â  Â  Â  if (func(t[i], i, t)) {
Â  Â  Â  Â  Â  Â  Â  Â  res[c++] = t[i];
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  else {
Â  Â  Â  Â  Â  while (++i \!== len) {
Â  Â  Â  Â  Â  Â  if (i in this) {
Â  Â  Â  Â  Â  Â  Â  if (func.call(thisArg, t[i], i, t)) {
Â  Â  Â  Â  Â  Â  Â  Â  res[c++] = t[i];
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  res.length = c;
Â  Â  Â  Â  return res;
Â  Â  Â  };
Â  Â  }

Â  Â  // Using 'var' for ES5 compatibility
Â  Â  var foodData = {};Â 

Â  Â  // Google Sheet URL
Â  Â  var CSV\_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQRQTEztCwC34GwFO1SN4evMaaZc2LxSMgI9Z8rgNh6VdiRPzRgswBFuXFWUxFd-g/pub?output=csv';

Â  Â  // --- Gemini API Configuration ---
Â  Â  // IMPORTANT: Replace "" with your actual Gemini API Key for AI features to work.
Â  Â  var API\_KEY = ""; // \<-- \*\*\*\* INSERT YOUR GEMINI API KEY HERE \*\*\*\*
Â  Â  var GEMINI\_TEXT\_MODEL = "gemini-1.5-flash-latest";
Â  Â  var GEMINI\_VISION\_MODEL = "gemini-1.5-flash-latest";
Â  Â  // --------------------------------

Â  Â  // Define markers globally for use in extraction logic.
Â  Â  // Includes variations like "Research:" or "Research basis" to maximize compatibility and fulfill requirements.
// UPDATED: Changed GPT to Gen
Â  Â  var BASIS\_MARKERS = [
Â  Â  Â  Â  { basis: 'Research', patterns: ['research basis', 'research:'] },
Â  Â  Â  Â  { basis: 'Book', patterns: ['book basis', 'book:'] },
Â  Â  Â  Â  { basis: 'Gen', patterns: ['gen basis', 'gen:'] }
Â  Â  ];

Â  Â  // Helper function to define fields (allows custom display names)
Â  Â  function defineField(key, displayName) {
Â  Â  Â  Â  // If displayName is not provided, it will be null.
Â  Â  Â  Â  return { key: key, displayName: displayName || null };
Â  Â  }

```
// NEW: Helper function to get color based on basis key (references CSS variables)
```

Â  Â  function getBasisColor(key) {
Â  Â  Â  Â  if (key === 'Research') return 'var(--color-basis-research)';
Â  Â  Â  Â  if (key === 'Book') return 'var(--color-basis-book)';
Â  Â  Â  Â  if (key === 'Gen') return 'var(--color-basis-gen)';
Â  Â  Â  Â  return 'inherit'; // Default color
Â  Â  }

Â  Â  // Configuration for the sections (icons)
Â  Â  // NOTE: Keys must match the CSV headers exactly.
Â  Â  var sectionDefinitions = {
Â  Â  Â  Â  "Nutrition": {
Â  Â  Â  Â  Â  Â  id: "nutrition",
Â  Â  Â  Â  Â  Â  icon: "fitness\_center",
Â  Â  Â  Â  Â  Â  colorVar: "--color-nutrition",
Â  Â  Â  Â  Â  Â  fields: [
Â  Â  Â  Â  Â  Â  Â  Â  defineField("Macros (100 g)"),
Â  Â  Â  Â  Â  Â  Â  Â  defineField("Micros (% RDA)"),
Â  Â  Â  Â  Â  Â  Â  Â  defineField("Macros Health Effect"),
Â  Â  Â  Â  Â  Â  Â  Â  defineField("Fat Type (%)"),
Â  Â  Â  Â  Â  Â  Â  Â  defineField("Fatty Acid Breakdown (%) (only for Oil)"),
Â  Â  Â  Â  Â  Â  Â  Â  defineField("Fatty Acid Composition (Detailed %) (only for Diary)"),
Â  Â  Â  Â  Â  Â  Â  Â  defineField("Omega Profile (n-3/n-6 ratio) (only for Oil)", "Omega Profile (n-3/n-6 ratio)"),
Â  Â  Â  Â  Â  Â  Â  Â  defineField("CLA & SCFA Profile (mg/g or %) (only for Diary)", "Probiotics")
Â  Â  Â  Â  Â  Â  ]
Â  Â  Â  Â  },
Â  Â  Â  Â  "Bioactives": {
Â  Â  Â  Â  Â  Â  id: "bioactives",
Â  Â  Â  Â  Â  Â  icon: "bolt",
Â  Â  Â  Â  Â  Â  colorVar: "--color-bioactives",
Â  Â  Â  Â  Â  Â  fields: [
Â  Â  Â  Â  Â  Â  Â  Â  defineField("Key Bioactives (mg/g)"),
Â  Â  Â  Â  Â  Â  Â  Â  defineField("TPC (mg GAE/g)"),
Â  Â  Â  Â  Â  Â  Â  Â  defineField("Antioxidant Compounds (Functional Breakdown)"),
Â  Â  Â  Â  Â  Â  Â  Â  defineField("Probiotic / Bioactive Peptide Insight (only for Diary)", "Probiotics")
Â  Â  Â  Â  Â  Â  ]
Â  Â  Â  Â  },
Â  Â  Â  Â  "Usage & Safety": {
Â  Â  Â  Â  Â  Â  id: "usage",
Â  Â  Â  Â  Â  Â  icon: "health\_and\_safety",
Â  Â  Â  Â  Â  Â  colorVar: "--color-usage",
Â  Â  Â  Â  Â  Â  fields: [
Â  Â  Â  Â  Â  Â  Â  Â  defineField("Ideal Preparation"),
Â  Â  Â  Â  Â  Â  Â  Â  defineField("Ideal Dosage"),
Â  Â  Â  Â  Â  Â  Â  Â  defineField("Maximiser"),
Â  Â  Â  Â  Â  Â  Â  Â  // Using the exact column name from the provided CSV link for reliability.
Â  Â  Â  Â  Â  Â  Â  Â  defineField("Potential health Impacts (wrong food pairing, consumption timings, over consumption) (P)", "Potential health Impacts"),
Â  Â  Â  Â  Â  Â  Â  Â  defineField("Clinical Synergy / Key Combinations (Only for herbs)", "Ayurvedic Synergy")
Â  Â  Â  Â  Â  Â  ]
Â  Â  Â  Â  },
Â  Â  Â  Â  "Metabolic": {
Â  Â  Â  Â  Â  Â  id: "metabolic",
Â  Â  Â  Â  Â  Â  icon: "speed",
Â  Â  Â  Â  Â  Â  colorVar: "--color-metabolic",
Â  Â  Â  Â  Â  Â  fields: [
Â  Â  Â  Â  Â  Â  Â  Â  defineField("Insulin Impact (GL)"),
Â  Â  Â  Â  Â  Â  Â  Â  defineField("Harmonal effects (U)"),
Â  Â  Â  Â  Â  Â  Â  Â  defineField("Modern Clinical Insight")
Â  Â  Â  Â  Â  Â  ]
Â  Â  Â  Â  },
Â  Â  Â  Â  // Renamed Section
Â  Â  Â  Â  "Fermentation": {Â 
Â  Â  Â  Â  Â  Â  id: "tradition",
Â  Â  Â  Â  Â  Â  icon: "bubble\_chart",
Â  Â  Â  Â  Â  Â  colorVar: "--color-tradition",
Â  Â  Â  Â  Â  Â  fields: [
Â  Â  Â  Â  Â  Â  Â  Â  defineField("Notes, Fermentation Effect", "Benefits of Fermentation and Methods"),
Â  Â  Â  Â  Â  Â  Â  Â  defineField("Fermentation Mechanism & Ayurvedic Parallel (only for Diary)")
Â  Â  Â  Â  Â  Â  ]
Â  Â  Â  Â  },
Â  Â  Â  Â  "Herbal Insights": {
Â  Â  Â  Â  Â  Â  id: "herbal",
Â  Â  Â  Â  Â  Â  icon: "eco",
Â  Â  Â  Â  Â  Â  colorVar: "--color-herbal",
Â  Â  Â  Â  Â  Â  fields: [
Â  Â  Â  Â  Â  Â  Â  Â  defineField("Active Phytochemical Class (only for Herbs)"),
Â  Â  Â  Â  Â  Â  Â  Â  defineField("Effect When Taken Before Food (Only for herbs)"),
Â  Â  Â  Â  Â  Â  Â  Â  defineField("Effect When Taken After Food (Only for herbs)"),
Â  Â  Â  Â  Â  Â  Â  Â  defineField("Timing Insight (Circadian / Metabolic Phase) (Only for herbs)", "Circadian / Metabolic Phase"),
Â  Â  Â  Â  Â  Â  Â  Â  defineField("Timing Insight (Neuroendocrine & Hormonal Synchrony) (only for herbs)", "Hormonal Synchrony")
Â  Â  Â  Â  Â  Â  ],
Â  Â  Â  Â  Â  Â  isConditional: true
Â  Â  Â  Â  },
Â  Â  Â  Â  "Notes/Wisdom": {
Â  Â  Â  Â  Â  Â  id: "notes",
Â  Â  Â  Â  Â  Â  icon: "history\_edu",
Â  Â  Â  Â  Â  Â  colorVar: "--color-notes",
Â  Â  Â  Â  Â  Â  fields: [
Â  Â  Â  Â  Â  Â  Â  Â  defineField("Notes / Traditional Wisdom"),
Â  Â  Â  Â  Â  Â  Â  Â  defineField("Ayurvedic Energetics & Lipid Function (only for Oil)"),
Â  Â  Â  Â  Â  Â  Â  Â  defineField("Ayurvedic Energetics in plain English (Only for herbs)", "Ayurvedic Energetics"),
Â  Â  Â  Â  Â  Â  Â  Â  defineField("Basis(Leaf/Root) (only for herbs)", "Herb Basis: Root/Leaf/Stem")
Â  Â  Â  Â  Â  Â  ]
Â  Â  Â  Â  },
Â  Â  Â  Â  "References": {
Â  Â  Â  Â  Â  Â  id: "references",
Â  Â  Â  Â  Â  Â  icon: "menu\_book",
Â  Â  Â  Â  Â  Â  colorVar: "--color-references",
Â  Â  Â  Â  Â  Â  fields: [
Â  Â  Â  Â  Â  Â  Â  Â  defineField("Cite (PubMed)"),
Â  Â  Â  Â  Â  Â  Â  Â  defineField("Project file references")
Â  Â  Â  Â  Â  Â  ]
Â  Â  Â  Â  }
Â  Â  };

Â  Â  // Initialize elements
Â  Â  var categorySelect, foodSelect, basisSelect, basisWrapper;
Â  Â  var mainContent = document.getElementById('main-content');
Â  Â  var loadingIndicator = document.getElementById('loading');
Â  Â  var selectionPanel = document.getElementById('selection-panel');
Â  Â  var dynamicTabContent = document.getElementById('tab-dynamic');
Â  Â  var dynamicTabButton = document.getElementById('tab-btn-dynamic');
Â  Â  var foodImage = document.getElementById('food-image');
Â  Â  var imageContainer = document.getElementById('image-container');
Â  Â  var imagePlaceholderText = document.getElementById('image-placeholder-text');
Â  Â  var dropdownsContainer = document.getElementById('dropdowns-container');
Â  Â  var selectionModal = document.getElementById('selection-modal');
Â  Â  var modalDropdownsTarget = document.getElementById('modal-dropdowns-target');

Â  Â  // AI Feature Elements
Â  Â  var aiModal = document.getElementById('ai-modal');
Â  Â  var modalMessage = document.getElementById('modal-message');
Â  Â  var modalSpinner = document.getElementById('modal-spinner');
Â  Â  var modalCloseBtn = document.getElementById('modal-close-btn');
Â  Â  var cameraInput = document.getElementById('camera-input');
Â  Â  var aiSummaryBtn = document.getElementById('ai-summary-btn');
Â  Â  var aiSummaryContent = document.getElementById('ai-summary-content');
Â  Â  var aiSummarySection = document.getElementById('ai-summary-section');
Â  Â  var cameraButtonElement = document.querySelector('.camera-button');

Â  Â  // --- Initialization and UI Setup ---

Â  Â  // Initialize the dropdown elements now that they are defined
Â  Â  function initializeDropdownElements() {
Â  Â  Â  Â  categorySelect = document.getElementById('category-select');
Â  Â  Â  Â  foodSelect = document.getElementById('food-select');
Â  Â  Â  Â  basisSelect = document.getElementById('basis-select');
Â  Â  Â  Â  basisWrapper = document.getElementById('basis-wrapper');
Â  Â  Â  Â  setupEventListeners();
Â  Â  }

Â  Â  // Function to manage dropdown placement based on screen size
Â  Â  function manageDropdownPlacement() {
Â  Â  Â  Â  // Check if screen width is mobile (less than 600px)
Â  Â  Â  Â  if (window.innerWidth \< 600) {
Â  Â  Â  Â  Â  Â  // Move dropdowns to the modal target
Â  Â  Â  Â  Â  Â  modalDropdownsTarget.appendChild(dropdownsContainer);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // Move dropdowns to the desktop selection panel
Â  Â  Â  Â  Â  Â  selectionPanel.appendChild(dropdownsContainer);
Â  Â  Â  Â  }
Â  Â  Â  Â  // Ensure the container is visible once moved (using flex for desktop compatibility)
Â  Â  Â  Â  dropdownsContainer.style.display = 'flex';
Â  Â  }

Â  Â  // Modal controls
Â  Â  function openSelectionModal() {
Â  Â  Â  Â  selectionModal.style.display = 'flex';
Â  Â  Â  Â  // Prevent background scrolling when modal is open
Â  Â  Â  Â  document.body.style.overflow = 'hidden';
Â  Â  }

Â  Â  function closeSelectionModal() {
Â  Â  Â  Â  selectionModal.style.display = 'none';
Â  Â  Â  Â  document.body.style.overflow = 'auto';
Â  Â  }

Â  Â  // --- Data Fetching and Processing ---

Â  Â  function fetchAndProcessData() {
// Ensure camera button is disabled while loading
if (cameraButtonElement) {
cameraButtonElement.disabled = true;
cameraButtonElement.title = "Loading data...";
}
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Papa.parse(CSV\_URL, {
Â  Â  Â  Â  Â  Â  Â  Â  download: true,
Â  Â  Â  Â  Â  Â  Â  Â  header: true,
Â  Â  Â  Â  Â  Â  Â  Â  skipEmptyLines: 'greedy',
Â  Â  Â  Â  Â  Â  Â  Â  dynamicTyping: false,
Â  Â  Â  Â  Â  Â  Â  Â  complete: function(results) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (results.errors.length \> 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn("Errors during parsing:", results.errors);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (results.data && results.data.length \> 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  processCSVData(results.data);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  initializeUI();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (results.errors.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("No data fetched from CSV URL.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loadingIndicator.textContent = 'Error: No data received from Google Spreadsheet. Check URL and sharing settings.';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  error: function(error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error parsing CSV:", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loadingIndicator.textContent = 'Error loading data. Check the URL and network connection.';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error("Error fetching data:", error);
Â  Â  Â  Â  Â  Â  loadingIndicator.textContent = 'Error initializing application.';
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // Processes the CSV data.
Â  Â  function processCSVData(data) {
Â  Â  Â  Â  var structuredData = {};

Â  Â  Â  Â  if (data.length === 0) return;

Â  Â  Â  Â  // --- Determine Structure and Keys ---
Â  Â  Â  Â  var headers = Object.keys(data[0]);
Â  Â  Â  Â  var CATEGORY\_KEY = null;
Â  Â  Â  Â  var FOOD\_KEY = null;
Â  Â  Â  Â  var BASIS\_KEY = null;
Â  Â  Â  Â  var isFlattened = false;

Â  Â  Â  Â  // 1. Attempt to find standardized keys
Â  Â  Â  Â  CATEGORY\_KEY = headers.find(function(h) { return h.trim().toLowerCase() === 'category'; });
Â  Â  Â  Â  FOOD\_KEY = headers.find(function(h) { return h.trim().toLowerCase() === 'food'; });
Â  Â  Â  Â  BASIS\_KEY = headers.find(function(h) {Â 
Â  Â  Â  Â  Â  Â  var lowerH = h.trim().toLowerCase();
Â  Â  Â  Â  Â  Â  return lowerH === 'basis';Â 
Â  Â  Â  Â  });

Â  Â  Â  Â  if (CATEGORY\_KEY && FOOD\_KEY) {
Â  Â  Â  Â  Â  Â  isFlattened = (BASIS\_KEY === null);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // 2. Fallback logic
Â  Â  Â  Â  Â  Â  console.warn("Standard 'Category'/'Food' headers not found. Attempting fallback.");
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â // Check if structure is Category, Sl No., Food (as in the provided link)
Â  Â  Â  Â  Â  Â  if (headers.length \>= 3 && headers[1].toLowerCase() === 'sl no.') {
Â  Â  Â  Â  Â  Â  Â  Â  CATEGORY\_KEY = headers[0];
Â  Â  Â  Â  Â  Â  Â  Â  FOOD\_KEY = headers[2];
Â  Â  Â  Â  Â  Â  Â  Â  isFlattened = (BASIS\_KEY === null);
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  else if (headers.length \>= 2) {
Â  Â  Â  Â  Â  Â  Â  Â  CATEGORY\_KEY = headers[0];
Â  Â  Â  Â  Â  Â  Â  Â  FOOD\_KEY = headers[1];
Â  Â  Â  Â  Â  Â  Â  Â  if (headers.length \>= 3 && headers[2].toLowerCase() \!== 'sl no.') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  BASIS\_KEY = headers[2];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isFlattened = false;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isFlattened = true;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  else {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("CSV file structure is unrecognized or has insufficient columns.");
Â  Â  Â  Â  Â  Â  Â  Â  loadingIndicator.textContent = 'Error: Unrecognized CSV structure.';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // If the structure is flattened (no 'Basis' column), assign the data to "All".
Â  Â  Â  Â  var DEFAULT\_BASIS = 'All';Â 

Â  Â  Â  Â  // --- Process Data Rows ---
Â  Â  Â  Â  data.forEach(function(row) {
Â  Â  Â  Â  Â  Â  var categoryRaw = row[CATEGORY\_KEY];
Â  Â  Â  Â  Â  Â  var foodRaw = row[FOOD\_KEY];
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  var basisRaw;

Â  Â  Â  Â  Â  Â  if (isFlattened) {
Â  Â  Â  Â  Â  Â  Â  Â  basisRaw = DEFAULT\_BASIS;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // Use the basis from the row. If the basis column exists but is empty for this row, we also default it.
Â  Â  Â  Â  Â  Â  Â  Â  basisRaw = (BASIS\_KEY && row[BASIS\_KEY] && row[BASIS\_KEY].trim() \!== "") ? row[BASIS\_KEY] : DEFAULT\_BASIS;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  var category = categoryRaw ? categoryRaw.trim() : null;
Â  Â  Â  Â  Â  Â  var food = foodRaw ? foodRaw.trim() : null;
Â  Â  Â  Â  Â  Â  var basis = basisRaw ? basisRaw.trim() : null;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Standardize basis names if they are provided (e.g. R -\> Research), unless it is "All"
// UPDATED: Changed GPT/G to Gen, including legacy 'gpt' check just in case.
Â  Â  Â  Â  Â  Â  if (basis && basis \!== 'All') {
Â  Â  Â  Â  Â  Â  Â  Â  if (basis.toUpperCase() === 'R' || basis.toLowerCase() === 'research') basis = 'Research';
Â  Â  Â  Â  Â  Â  Â  Â  else if (basis.toUpperCase() === 'B' || basis.toLowerCase() === 'book') basis = 'Book';
Â  Â  Â  Â  Â  Â  Â  Â  else if (basis.toUpperCase() === 'G' || basis.toLowerCase() === 'gen' || basis.toLowerCase() === 'gpt') basis = 'Gen';
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (\!category || \!food || \!basis) return;

Â  Â  Â  Â  Â  Â  if (\!structuredData[category]) {
Â  Â  Â  Â  Â  Â  Â  Â  structuredData[category] = {};
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (\!structuredData[category][food]) {
Â  Â  Â  Â  Â  Â  Â  Â  structuredData[category][food] = {};
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Note: Removed the optimization check for flattened structure here to ensure all rows are processed,Â 
Â  Â  Â  Â  Â  Â  // allowing data from multiple rows for the same food/basis to be appended if necessary.

Â  Â  Â  Â  Â  Â  Object.keys(row).forEach(function(key) {
Â  Â  Â  Â  Â  Â  Â  Â  var fieldName = key.trim();

Â  Â  Â  Â  Â  Â  Â  Â  // Skip identifiers and known irrelevant columns
Â  Â  Â  Â  Â  Â  Â  Â  if (fieldName === CATEGORY\_KEY || fieldName === FOOD\_KEY || fieldName.toLowerCase() === 'sl no.' || \!fieldName) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Skip the basis key if it exists
Â  Â  Â  Â  Â  Â  Â  Â  if (BASIS\_KEY && fieldName === BASIS\_KEY) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  var valueRaw = row[key];
Â  Â  Â  Â  Â  Â  Â  Â  var value = valueRaw ? valueRaw.trim() : null;

Â  Â  Â  Â  Â  Â  Â  Â  if (value) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (fieldName.toLowerCase() === 'image') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (\!structuredData[category][food]['\_imageUrl']) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  structuredData[category][food]['\_imageUrl'] = value;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Maintain the nested structure { Field: { Basis: Value } }Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (\!structuredData[category][food][fieldName]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  structuredData[category][food][fieldName] = {};
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Handle appending data
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (structuredData[category][food][fieldName][basis]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  structuredData[category][food][fieldName][basis] += '\\n\\n' + value;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  structuredData[category][food][fieldName][basis] = value;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  Â  Â  foodData = structuredData;
Â  Â  }

Â  Â  // --- UI Initialization ---

Â  Â  function initializeUI() {
Â  Â  Â  Â  if (Object.keys(foodData).length === 0) {
Â  Â  Â  Â  Â  Â  // Check if a specific error message hasn't already been set
Â  Â  Â  Â  Â  Â  if (loadingIndicator.textContent.startsWith('Loading')) {
Â  Â  Â  Â  Â  Â  Â  Â loadingIndicator.textContent = "Data processed, but no valid entries were found. Check CSV format and content.";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Setup the dropdown elements and their placement
Â  Â  Â  Â  initializeDropdownElements();
Â  Â  Â  Â  manageDropdownPlacement();
Â  Â  Â  Â  // Add listener for window resize to re-evaluate placement
Â  Â  Â  Â  window.addEventListener('resize', manageDropdownPlacement);

Â  Â  Â  Â  populateCategories();
Â  Â  Â  Â  generateIconButtons();
Â  Â  Â  Â  setupTabListeners();
// UPDATED: setupAIListeners is called here, ensuring data is loaded before enabling AI features.
Â  Â  Â  Â  setupAIListeners();Â 
Â  Â  Â  Â  loadingIndicator.style.display = 'none';
Â  Â  Â  Â  // The selection panel display is now handled by CSS media queries and JS placement
Â  Â  }

Â  Â  function populateCategories() {
Â  Â  Â  Â  var categories = Object.keys(foodData).sort();
Â  Â  Â  Â  categories.forEach(function(category) {
Â  Â  Â  Â  Â  Â  var option = document.createElement('option');
Â  Â  Â  Â  Â  Â  option.value = category;
Â  Â  Â  Â  Â  Â  option.textContent = category;
Â  Â  Â  Â  Â  Â  categorySelect.appendChild(option);
Â  Â  Â  Â  });
Â  Â  }

Â  Â  // Generates Icon buttons
Â  Â  function generateIconButtons() {
Â  Â  Â  Â  var iconRow = document.getElementById('icon-row');
Â  Â  Â  Â  iconRow.innerHTML = '';

Â  Â  Â  Â  for (var sectionName in sectionDefinitions) {
Â  Â  Â  Â  Â  Â  if (Object.prototype.hasOwnProperty.call(sectionDefinitions, sectionName)) {
Â  Â  Â  Â  Â  Â  Â  Â  var config = sectionDefinitions[sectionName];
Â  Â  Â  Â  Â  Â  Â  Â  var button = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  button.className = 'icon-button';
Â  Â  Â  Â  Â  Â  Â  Â  button.id = 'icon-btn-' + config.id;
Â  Â  Â  Â  Â  Â  Â  Â  button.setAttribute('data-section', config.id);
Â  Â  Â  Â  Â  Â  Â  Â  button.setAttribute('data-color-var', config.colorVar);
Â  Â  Â  Â  Â  Â  Â  Â  button.setAttribute('title', sectionName);

Â  Â  Â  Â  Â  Â  Â  Â  // Generate Icon ONLY
Â  Â  Â  Â  Â  Â  Â  Â  button.innerHTML = '\<i class="material-icons"\>' + config.icon + '\</i\>';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // ES5 compatibility closure for onclick event
Â  Â  Â  Â  Â  Â  Â  Â  button.onclick = (function(id, colorVar, name) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return function() {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selectSection(id, colorVar, name);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  })(config.id, config.colorVar, sectionName);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  iconRow.appendChild(button);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // --- Event Listeners ---

Â  Â  // REVISED: Ensures content correctly refreshes when basis selection changes.
Â  Â  function setupEventListeners() {
Â  Â  Â  Â  categorySelect.addEventListener('change', function() {
Â  Â  Â  Â  Â  Â  var category = this.value;
Â  Â  Â  Â  Â  Â  foodSelect.innerHTML = '\<option value=""\>Select Food...\</option\>';Â 
Â  Â  Â  Â  Â  Â  foodSelect.value = "";
Â  Â  Â  Â  Â  Â  mainContent.style.display = 'none';
Â  Â  Â  Â  Â  Â  imageContainer.style.display = 'none';
Â  Â  Â  Â  Â  Â  // Reset basis when category changes
Â  Â  Â  Â  Â  Â  basisSelect.value = "All";

Â  Â  Â  Â  Â  Â  if (category && foodData[category]) {
Â  Â  Â  Â  Â  Â  Â  Â  foodSelect.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  var foods = Object.keys(foodData[category]).sort();
Â  Â  Â  Â  Â  Â  Â  Â  foods.forEach(function(food) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  var option = document.createElement('option');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  option.value = food;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  option.textContent = food;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  foodSelect.appendChild(option);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  foodSelect.disabled = true;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  // When food changes, update the display
Â  Â  Â  Â  foodSelect.addEventListener('change', displayFoodDetails);
Â  Â  Â  Â Â 
Â  Â  Â  Â  // When basis changes, re-render the current food details
Â  Â  Â  Â  basisSelect.addEventListener('change', function() {
Â  Â  Â  Â  Â  Â  // Ensure a food is actually selected before trying to refresh
Â  Â  Â  Â  Â  Â  if (foodSelect.value && categorySelect.value) {
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // 1. Update Overview Tab content (This always runs)
Â  Â  Â  Â  Â  Â  Â  Â  populateOverview();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // 2. Update Icon Visibility based on new basis
Â  Â  Â  Â  Â  Â  Â  Â  updateIconVisibility();

Â  Â  Â  Â  Â  Â  Â  Â  // 3. Update Details Tab content and handle section switching
Â  Â  Â  Â  Â  Â  Â  Â  var activeIcon = document.querySelector('.icon-button.active');
Â  Â  Â  Â  Â  Â  Â  Â  // Determine if we need a new section: if no icon is active OR the active icon is now hidden.
Â  Â  Â  Â  Â  Â  Â  Â  var needsNewSection = \!activeIcon || activeIcon.style.display === 'none';

Â  Â  Â  Â  Â  Â  Â  Â  // If the active icon exists but is now hidden, deactivate it.
Â  Â  Â  Â  Â  Â  Â  Â  if (activeIcon && needsNewSection) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  activeIcon.classList.remove('active');
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  if (needsNewSection) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // Find the first visible icon
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â var icons = document.querySelectorAll('.icon-button');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â var firstVisibleIcon = null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â for (var i = 0; i \< icons.length; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (icons[i].style.display \!== 'none') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â firstVisibleIcon = icons[i];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â break;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (firstVisibleIcon) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // Select the new section.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â var sectionId = firstVisibleIcon.getAttribute('data-section');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â var colorVar = firstVisibleIcon.getAttribute('data-color-var');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â var sectionName = firstVisibleIcon.getAttribute('title');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // Force update the section content.Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â selectSection(sectionId, colorVar, sectionName, true);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // If the Details tab is currently visible, we must ensure the colors update correctly for the new section immediately.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (document.getElementById('tab-btn-dynamic').classList.contains('active')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â updateColors(colorVar);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // Handle case where no icons are visible for this basis
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â dynamicTabContent.innerHTML = '\<p class="no-data"\>No detailed data available for this basis.\</p\>';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Reset color if on details tab
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (document.getElementById('tab-btn-dynamic').classList.contains('active')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateColors('--color-overview');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  } else if (activeIcon) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // If the active icon is still visible, just regenerate its content.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  var sectionId = activeIcon.getAttribute('data-section');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  generateDynamicContent(sectionId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Colors don't need updating here as the section hasn't changed.
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  }

Â  Â  // --- AI Feature Listeners ---
// UPDATED: This function now handles enabling the camera button if the API key is present.
Â  Â  function setupAIListeners() {
Â  Â  Â  Â  // Modal close button listener is always needed
Â  Â  Â  Â  modalCloseBtn.addEventListener('click', hideModal);

Â  Â  Â  Â  // Check if API Key is provided before enabling AI features
Â  Â  Â  Â  if (\!API\_KEY || API\_KEY.trim() === "") {
Â  Â  Â  Â  Â  Â  console.warn("Gemini API Key is missing. AI features (Camera, Summary, Recipe) will be disabled.");
Â  Â  Â  Â  Â  Â  // Update camera button status (it may have been disabled during loading)
Â  Â  Â  Â  Â  Â  if (cameraButtonElement) {
cameraButtonElement.disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  cameraButtonElement.title = "AI Camera Disabled (Missing API Key)";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Hide the AI Summary section entirely if disabled
Â  Â  Â  Â  Â  Â  aiSummarySection.style.display = 'none';

Â  Â  Â  Â  Â  Â  return; // Exit setup if no key
Â  Â  Â  Â  }

```
    // --- API Key is present AND data is loaded (since this is called from initializeUI) ---
    
    // Enable the camera button
    if (cameraButtonElement) {
        cameraButtonElement.disabled = false;
        cameraButtonElement.title = &quot;Identify Food&quot;;
    }
```

Â  Â  Â  Â  // Camera file input
Â  Â  Â  Â  cameraInput.addEventListener('change', handleImageUpload);
Â  Â  Â  Â Â 
Â  Â  Â  Â  // AI Summary button
Â  Â  Â  Â  aiSummaryBtn.addEventListener('click', getAISummary);
Â  Â  }

Â  Â  // --- Display Logic ---

Â  Â  // This is called when the FOOD selection changes.
Â  Â  function displayFoodDetails() {
Â  Â  Â  Â  var category = categorySelect.value;
Â  Â  Â  Â  var foodName = foodSelect.value;

Â  Â  Â  Â  // Close the modal if open (mobile view)
Â  Â  Â  Â  if (selectionModal && selectionModal.style.display === 'flex') {
Â  Â  Â  Â  Â  Â  closeSelectionModal();
Â  Â  Â  Â  }

Â  Â  Â  Â  if (category && foodName && foodData[category] && foodData[category][foodName]) {
Â  Â  Â  Â  Â  Â  var data = foodData[category][foodName];
Â  Â  Â  Â  Â  Â  document.getElementById('food-title').textContent = foodName;

Â  Â  Â  Â  Â  Â  // 0. Ensure Basis dropdown is visible and set correctly
Â  Â  Â  Â  Â  Â  manageBasisSelector(data);

Â  Â  Â  Â  Â  Â  // 1. Populate Overview Tab
Â  Â  Â  Â  Â  Â  populateOverview();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // 2. Update Image Display
Â  Â  Â  Â  Â  Â  updateImageDisplay(data);

Â  Â  Â  Â  Â  Â  // 3. Update visibility of conditional icons
Â  Â  Â  Â  Â  Â  updateIconVisibility();

Â  Â  Â  Â  Â  Â  // 4. Select the first available visible icon
Â  Â  Â  Â  Â  Â  var icons = document.querySelectorAll('.icon-button');
Â  Â  Â  Â  Â  Â  var firstVisibleIcon = null;
Â  Â  Â  Â  Â  Â  for (var i = 0; i \< icons.length; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  if (icons[i].style.display \!== 'none') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  firstVisibleIcon = icons[i];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (firstVisibleIcon) {
Â  Â  Â  Â  Â  Â  Â  Â  var sectionId = firstVisibleIcon.getAttribute('data-section');
Â  Â  Â  Â  Â  Â  Â  Â  var colorVar = firstVisibleIcon.getAttribute('data-color-var');
Â  Â  Â  Â  Â  Â  Â  Â  // The section name is stored in the title attribute (e.g., "Fermentation")
Â  Â  Â  Â  Â  Â  Â  Â  var sectionName = firstVisibleIcon.getAttribute('title');

Â  Â  Â  Â  Â  Â  Â  Â  // Force update ensures the content is generated for the selected (or default) basis
Â  Â  Â  Â  Â  Â  Â  Â  selectSection(sectionId, colorVar, sectionName, true);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  dynamicTabContent.innerHTML = '\<p class="no-data"\>No detailed data available.\</p\>';
Â  Â  Â  Â  Â  Â  Â  Â  dynamicTabButton.textContent = "Details";
Â  Â  Â  Â  Â  Â  Â  Â  document.querySelectorAll('.icon-button').forEach(function(btn) { btn.classList.remove('active'); });
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // 5. Always switch to the Overview tab first when a new food is loaded
Â  Â  Â  Â  Â  Â  openTab('tab-overview');
Â  Â  Â  Â  Â  Â  mainContent.style.display = 'block';

Â  Â  Â  Â  Â  Â  // 6. Reset AI Summary content when food changes
Â  Â  Â  Â  Â  Â  if (API\_KEY && API\_KEY.trim() \!== "") {
Â  Â  Â  Â  Â  Â  Â  Â  aiSummaryContent.innerHTML = '\<p class="no-data"\>Click the button to generate an AI-powered summary of this food&\#39;s benefits.\</p\>';
Â  Â  Â  Â  Â  Â  Â  Â  aiSummaryBtn.disabled = false;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  } else if (foodName === "") {
Â  Â  Â  Â  Â  Â  mainContent.style.display = 'none';
Â  Â  Â  Â  Â  Â  imageContainer.style.display = 'none';
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // REVISED: Manages the Basis dropdown. Ensures it is always visible and options are always enabled.
Â  Â  function manageBasisSelector(data) {
Â  Â  Â  Â  // The basis wrapper should always be visible when a food is selected.
Â  Â  Â  Â  basisWrapper.style.display = 'flex';

Â  Â  Â  Â  // Ensure all options are enabled. The user should be able to select R/B/G/All at any time.
Â  Â  Â  Â  var options = basisSelect.options;
Â  Â  Â  Â  for (var i = 0; i \< options.length; i++) {
Â  Â  Â  Â  Â  Â  options[i].disabled = false;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Ensure a default selection if none is set (e.g., initial load)
Â  Â  Â  Â  if (basisSelect.value === "") {
Â  Â  Â  Â  Â  Â  basisSelect.value = 'All';
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function updateImageDisplay(data) {
Â  Â  Â  Â  var imageUrl = data['\_imageUrl'];
Â  Â  Â  Â Â 
Â  Â  Â  Â  foodImage.style.display = 'none';
Â  Â  Â  Â  imagePlaceholderText.style.display = 'none';
Â  Â  Â  Â  imageContainer.style.display = 'none';

Â  Â  Â  Â  if (imageUrl && isValidContent(imageUrl)) {
Â  Â  Â  Â  Â  Â  foodImage.src = imageUrl;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  foodImage.onload = function() {
Â  Â  Â  Â  Â  Â  Â  Â  Â foodImage.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  Â imageContainer.style.display = 'block';
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  foodImage.onerror = function() {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Failed to load image:", imageUrl);
Â  Â  Â  Â  Â  Â  Â  Â  imagePlaceholderText.textContent = "Image link broken or failed to load.";
Â  Â  Â  Â  Â  Â  Â  Â  imagePlaceholderText.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  imageContainer.style.display = 'block';
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // Check if there is other data besides the image URL
Â  Â  Â  Â  Â  Â  var hasContentData = false;
Â  Â  Â  Â  Â  Â  for (var key in data) {
Â  Â  Â  Â  Â  Â  Â  Â  // Check that the key is not \_imageUrl AND that it holds meaningful data
Â  Â  Â  Â  Â  Â  Â  Â  if (Object.prototype.hasOwnProperty.call(data, key) && key \!== '\_imageUrl' && typeof data[key] === 'object' && data[key] \!== null && Object.keys(data[key]).length \> 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hasContentData = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (hasContentData) {
Â  Â  Â  Â  Â  Â  Â  Â  Â imagePlaceholderText.textContent = "Image not available in database.";
Â  Â  Â  Â  Â  Â  Â  Â  Â imagePlaceholderText.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  Â imageContainer.style.display = 'block';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function updateIconVisibility() {
Â  Â  Â  Â  Â // This function relies on the currently selected Basis value
Â  Â  Â  Â  Â for (var sectionName in sectionDefinitions) {
Â  Â  Â  Â  Â  Â  Â if (Object.prototype.hasOwnProperty.call(sectionDefinitions, sectionName)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â var config = sectionDefinitions[sectionName];
Â  Â  Â  Â  Â  Â  Â  Â  Â var iconButton = document.getElementById('icon-btn-' + config.id);
Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â if (iconButton) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // Check if the section has data for the CURRENTLY SELECTED basis
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (checkIfSectionHasData(config.id)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â iconButton.style.display = 'flex';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // Hide if no data is found for the current basis
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â iconButton.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â }
Â  Â  }

Â  Â  function populateOverview() {
Â  Â  Â  Â  var category = categorySelect.value;
Â  Â  Â  Â  var foodName = foodSelect.value;
Â  Â  Â  Â  // Get the currently selected basis from the dropdown
Â  Â  Â  Â  var basis = basisSelect.value;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Safety check
Â  Â  Â  Â  if (\!category || \!foodName || \!foodData[category] || \!foodData[category][foodName]) return;

Â  Â  Â  Â  var data = foodData[category][foodName];

Â  Â  Â  Â  // These IDs must match the HTML IDs, which correspond to the CSV headers for the overview fields.
Â  Â  Â  Â  populateField("Specific Benefits (min 50 to max 100 words) (K)", data, basis);
Â  Â  Â  Â  populateField("Health Tags", data, basis);
Â  Â  }

Â  Â  // Handles the logic when an icon button is clicked
Â  Â  function selectSection(sectionId, colorVar, sectionName, forceUpdate) {
Â  Â  Â  Â  forceUpdate = forceUpdate || false;

Â  Â  Â  Â  var currentActive = document.querySelector('.icon-button.active');

Â  Â  Â  Â  // If clicking the already active icon (and not forcing update), just switch to the dynamic tab.
Â  Â  Â  Â  if (currentActive && currentActive.getAttribute('data-section') === sectionId && \!forceUpdate) {
Â  Â  Â  Â  Â  Â  openTab('tab-dynamic');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Update active state
Â  Â  Â  Â  // We ensure any previously active icon is removed first.
Â  Â  Â  Â  if (currentActive) {
Â  Â  Â  Â  Â  Â  Â currentActive.classList.remove('active');
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  var selectedButton = document.getElementById('icon-btn-' + sectionId);
Â  Â  Â  Â  if (selectedButton) {
Â  Â  Â  Â  Â  Â  Â selectedButton.classList.add('active');
Â  Â  Â  Â  }

Â  Â  Â  Â  // Generate content based on the currently selected basis
Â  Â  Â  Â  generateDynamicContent(sectionId);

Â  Â  Â  Â  // Update the tab button name
Â  Â  Â  Â  dynamicTabButton.textContent = sectionName;

Â  Â  Â  Â  // Decide whether to switch tabs. Color updates are handled within openTab or explicitly in the basis change listener if needed.
Â  Â  Â  Â  if (\!forceUpdate) {
Â  Â  Â  Â  Â  Â  // If triggered by user click, switch to the dynamic tab
Â  Â  Â  Â  Â  Â  openTab('tab-dynamic');
Â  Â  Â  Â  }Â 
Â  Â  }

Â  Â  // Checks if a specific section has any data for the selected basis
Â  Â  function checkIfSectionHasData(sectionId) {
Â  Â  Â  Â  var category = categorySelect.value;
Â  Â  Â  Â  var foodName = foodSelect.value;
Â  Â  Â  Â  // Check against the currently selected basis
Â  Â  Â  Â  var basis = basisSelect.value;

Â  Â  Â  Â  if (\!category || \!foodName || \!foodData[category] || \!foodData[category][foodName]) return false;
Â  Â  Â  Â  var data = foodData[category][foodName];

Â  Â  Â  Â  // Standard loop to find config
Â  Â  Â  Â  var config = null;
Â  Â  Â  Â  for (var key in sectionDefinitions) {
Â  Â  Â  Â  Â  Â  if (Object.prototype.hasOwnProperty.call(sectionDefinitions, key) && sectionDefinitions[key].id === sectionId) {
Â  Â  Â  Â  Â  Â  Â  Â  config = sectionDefinitions[key];
Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  if (\!config) return false;

Â  Â  Â  Â  for (var i = 0; i \< config.fields.length; i++) {
Â  Â  Â  Â  Â  Â  // Access the key property of the field object
Â  Â  Â  Â  Â  Â  var fieldKey = config.fields[i].key;Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // formatData handles the logic of checking the specific basis
Â  Â  Â  Â  Â  Â  var content = formatData(data[fieldKey], basis);
Â  Â  Â  Â  Â  Â  if (isValidContent(content)) {
Â  Â  Â  Â  Â  Â  Â  Â  return true;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  return false;
Â  Â  }

Â  Â  // Generates the HTML content for the dynamic tab
Â  Â  function generateDynamicContent(sectionId) {
Â  Â  Â  Â  var category = categorySelect.value;
Â  Â  Â  Â  var foodName = foodSelect.value;
Â  Â  Â  Â  // Use the currently selected basis
Â  Â  Â  Â  var basis = basisSelect.value;

Â  Â  Â  Â  // Safety check
Â  Â  Â  Â  if (\!foodData[category] || \!foodData[category][foodName]) return;

Â  Â  Â  Â  var data = foodData[category][foodName];

Â  Â  Â  Â  // Standard loop to find config
Â  Â  Â  Â  var config = null;
Â  Â  Â  Â  for (var key in sectionDefinitions) {
Â  Â  Â  Â  Â  Â  if (Object.prototype.hasOwnProperty.call(sectionDefinitions, key) && sectionDefinitions[key].id === sectionId) {
Â  Â  Â  Â  Â  Â  Â  Â  config = sectionDefinitions[key];
Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  if (\!config) return;

Â  Â  Â  Â  var htmlContent = '';
Â  Â  Â  Â  var hasContent = false;

Â  Â  Â  Â  config.fields.forEach(function(fieldObject) {
Â  Â  Â  Â  Â  Â  // Use the key and displayName
Â  Â  Â  Â  Â  Â  var fieldKey = fieldObject.key;
Â  Â  Â  Â  Â  Â  var customDisplayName = fieldObject.displayName;

Â  Â  Â  Â  Â  Â  var content = formatData(data[fieldKey], basis);

Â  Â  Â  Â  Â  Â  if (isValidContent(content)) {
Â  Â  Â  Â  Â  Â  Â  Â  hasContent = true;
Â  Â  Â  Â  Â  Â  Â  Â  var displayContent = content;

Â  Â  Â  Â  Â  Â  Â  Â  // Apply reference formatting based on the field key
// This function now handles content that may already have color spans.
Â  Â  Â  Â  Â  Â  Â  Â  if (fieldKey === "Cite (PubMed)" || fieldKey === "Modern Clinical Insight") {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayContent = formatReferences(displayContent);
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  var displayFieldName;
Â  Â  Â  Â  Â  Â  Â  Â  if (customDisplayName) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Use the custom display name if provided
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayFieldName = customDisplayName;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Fallback to automatic cleaning of the key
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayFieldName = fieldKey.replace(/(only for .+)/gi, '').replace(/(.+)/g, '').trim();
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  htmlContent += '\<div class="info-section"\>' +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â '\<div class="info-title"\>' + displayFieldName + '\</div\>' +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â '\<div class="info-content"\>' + displayContent + '\</div\>' +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  '\</div\>';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  // --- Add AI Recipe Button to "Usage" section ---
Â  Â  Â  Â  // Only add if the API key is present
Â  Â  Â  Â  if (sectionId === 'usage' && API\_KEY && API\_KEY.trim() \!== "") {

Â  Â  Â  Â  Â  Â  htmlContent += '\<div class="info-section"\>' +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â '\<div class="info-title"\>âœ¨ Recipe Idea\</div\>' +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â '\<button id="ai-recipe-btn" class="ai-button"\>Get Recipe Idea\</button\>' +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â '\<div class="info-content" id="ai-recipe-content"\>' +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â '\<p class="no-data"\>Click the button for a healthy recipe idea.\</p\>' +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â '\</div\>' +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â '\</div\>';
Â  Â  Â  Â  Â  Â  hasContent = true;
Â  Â  Â  Â  }
Â  Â  Â  Â  // ------------------------------------------------

Â  Â  Â  Â  if (hasContent) {
Â  Â  Â  Â  Â  Â  dynamicTabContent.innerHTML = htmlContent;

Â  Â  Â  Â  Â  Â  // Add listener for the recipe button *after* it's added to the DOM
Â  Â  Â  Â  Â  Â  if (sectionId === 'usage' && API\_KEY && API\_KEY.trim() \!== "") {
Â  Â  Â  Â  Â  Â  Â  Â  var recipeBtn = document.getElementById('ai-recipe-btn');
Â  Â  Â  Â  Â  Â  Â  Â  if (recipeBtn) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  recipeBtn.addEventListener('click', getRecipeIdea);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â dynamicTabContent.innerHTML = '\<p class="no-data"\>No data available for this section under the selected basis.\</p\>';
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // --- Helper Functions ---

Â  Â  // \*\*\* NEW FUNCTION: Exhaustive Truncation Logic Implementation \*\*\*
Â  Â  // Helper function to implement the exhaustive text truncation logic
Â  Â  // This addresses issues where data for different bases (R/B/G) is combined in a single text block (often under the 'All' basis).
Â  Â  function extractBasisContent(fullText, selectedBasis) {
Â  Â  Â  Â  if (\!fullText || \!selectedBasis || selectedBasis === 'All') {
Â  Â  Â  Â  Â  Â  // Should not be called if 'All' is selected, but handled defensively.
Â  Â  Â  Â  Â  Â  return null;
Â  Â  Â  Â  }

Â  Â  Â  Â  // Use case-insensitive searching
Â  Â  Â  Â  var lowerText = fullText.toLowerCase();
Â  Â  Â  Â  var startIndex = -1;
Â  Â  Â  Â  var endIndex = -1;

Â  Â  Â  Â  // 1. Find the start index for the selected basis using the globally defined BASIS\_MARKERS
Â  Â  Â  Â  var selectedMarkerConfig = null;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // ES5 compatible loop
Â  Â  Â  Â  for (var m = 0; m \< BASIS\_MARKERS.length; m++) {
Â  Â  Â  Â  Â  Â  if (BASIS\_MARKERS[m].basis === selectedBasis) {
Â  Â  Â  Â  Â  Â  Â  Â  selectedMarkerConfig = BASIS\_MARKERS[m];
Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (selectedMarkerConfig) {
Â  Â  Â  Â  Â  Â  for (var i = 0; i \< selectedMarkerConfig.patterns.length; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  var index = lowerText.indexOf(selectedMarkerConfig.patterns[i]);
Â  Â  Â  Â  Â  Â  Â  Â  if (index \!== -1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // If we find a match, we check if it's earlier than a previously found match (if any)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (startIndex === -1 || index \< startIndex) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  startIndex = index;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // If the specific basis marker is not found in the text, we assume the data is not present for this basis in this block.
Â  Â  Â  Â  if (startIndex === -1) {
Â  Â  Â  Â  Â  Â  return null;Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  // 2. Find the end index (the start of the next basis: Book, Gen, or Research)
Â  Â  Â  Â  var potentialEndIndices = [];
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Iterate through all markers OTHER than the selected one to find the next section start.
Â  Â  Â  Â  BASIS\_MARKERS.forEach(function(marker) {
Â  Â  Â  Â  Â  Â  if (marker.basis \!== selectedBasis) {
Â  Â  Â  Â  Â  Â  Â  Â  marker.patterns.forEach(function(pattern) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Search for the next marker starting AFTER the current section's beginning.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  var index = lowerText.indexOf(pattern, startIndex + 1);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (index \!== -1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  potentialEndIndices.push(index);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  if (potentialEndIndices.length \> 0) {
Â  Â  Â  Â  Â  Â  // Find the earliest occurring next marker to define the end of the current section.
Â  Â  Â  Â  Â  Â  // ES5 compatibility for Math.min
Â  Â  Â  Â  Â  Â  endIndex = Math.min.apply(null, potentialEndIndices);
Â  Â  Â  Â  }

Â  Â  Â  Â  // 3. Extract the content
Â  Â  Â  Â  var result;
Â  Â  Â  Â  if (endIndex \!== -1 && endIndex \> startIndex) {
Â  Â  Â  Â  Â  Â  // Return the substring between the start of the selected basis and the start of the next basis.
Â  Â  Â  Â  Â  Â  result = fullText.substring(startIndex, endIndex).trim();
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // If no subsequent basis is found, return everything from the start index to the end of the text.
Â  Â  Â  Â  Â  Â  result = fullText.substring(startIndex).trim();
Â  Â  Â  Â  }

Â  Â  Â  Â  return result;
Â  Â  }

```
// UPDATED: Checks content validity, ignoring HTML tags.
```

Â  Â  function isValidContent(content) {
if (content === null || typeof content === 'undefined') return false;

```
    // Remove HTML tags (like color spans) before checking validity
    // This regex is safer than creating DOM elements from potentially unsafe strings
    var textOnly = content.toString().replace(/&lt;[^&gt;]*&gt;/g, &#39;&#39;).trim();
```

Â  Â  Â  Â  return textOnly \!== "" && textOnly.toUpperCase() \!== "N/A";
Â  Â  }

Â  Â  function updateColors(colorVar) {
Â  Â  Â  Â  document.documentElement.style.setProperty('--current-active-color', 'var(' + colorVar + ')');
Â  Â  }

Â  Â  function setupTabListeners() {
Â  Â  Â  Â  document.querySelectorAll('.tab-button').forEach(function(button) {
Â  Â  Â  Â  Â  Â  button.addEventListener('click', function() {
Â  Â  Â  Â  Â  Â  Â  Â  openTab(this.getAttribute('data-tab'));
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  }

Â  Â  function openTab(tabId) {
Â  Â  Â  Â  if (tabId === 'tab-overview') {
Â  Â  Â  Â  Â  Â  updateColors("--color-overview");
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  var activeIcon = document.querySelector('.icon-button.active');
Â  Â  Â  Â  Â  Â  if (activeIcon) {
Â  Â  Â  Â  Â  Â  Â  Â  updateColors(activeIcon.getAttribute('data-color-var'));
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // Fallback if no icon is active (e.g., if all icons are hidden)
Â  Â  Â  Â  Â  Â  Â  Â  updateColors("--color-overview");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  document.querySelectorAll('.tab-content').forEach(function(tc) { tc.classList.remove('active'); });
Â  Â  Â  Â  document.getElementById(tabId).classList.add('active');

Â  Â  Â  Â  document.querySelectorAll('.tab-button').forEach(function(button) {
Â  Â  Â  Â  Â  Â  if (button.getAttribute('data-tab') === tabId) {
Â  Â  Â  Â  Â  Â  Â  Â  button.classList.add('active');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  button.classList.remove('active');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  }

Â  Â  // \*\*\* UPDATED FUNCTION \*\*\*
Â  Â  // REVISED: Formats the data based on the selected basis, implements truncation logic, and applies colors.
Â  Â  function formatData(data, basis) {
Â  Â  Â  Â  if (\!data) return null;

Â  Â  Â  Â  // Scenario 1: User selected a specific basis (R, B, or G)
Â  Â  Â  Â  if (basis \!== 'All') {
var color = getBasisColor(basis);

Â  Â  Â  Â  Â  Â  // 1. Priority Check: Does data exist specifically under this basis key (R, B, or G)?
Â  Â  Â  Â  Â  Â  // This handles data structured with distinct basis entries.
Â  Â  Â  Â  Â  Â  if (data[basis] && isValidContent(data[basis])) {
// Apply color styling
Â  Â  Â  Â  Â  Â  Â  Â return '\<span style="color: ' + color + ';"\>' + data[basis] + '\</span\>';
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // 2. Fallback Check: If not found, iterate over ALL keys (including 'All') and attempt extraction.
Â  Â  Â  Â  Â  Â  // This handles flattened data where R/B/G content is combined in one block.
Â  Â  Â  Â  Â  Â  var keys = Object.keys(data);
Â  Â  Â  Â  Â  Â  for (var i = 0; i \< keys.length; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  var content = data[keys[i]];
Â  Â  Â  Â  Â  Â  Â  Â  if (isValidContent(content)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Use the new truncation/extraction logic
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  var extractedContent = extractBasisContent(content, basis);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isValidContent(extractedContent)) {
// Apply color styling
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return '\<span style="color: ' + color + ';"\>' + extractedContent + '\</span\>';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // 3. If nothing is found after all checks, return null.
Â  Â  Â  Â  Â  Â  return null;
Â  Â  Â  Â  }

Â  Â  Â  Â  // Scenario 2: User selected "All"
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Identify keys that have valid content (using the ES5 compatible filter polyfill)
Â  Â  Â  Â  var validKeys = Object.keys(data).filter(function(k) { return isValidContent(data[k]); });

```
    // Check if the data is truly flattened (only &quot;All&quot; key exists and has content, AND it doesn&#39;t contain internal basis markers)
    if (data[&quot;All&quot;] &amp;&amp; validKeys.length === 1 &amp;&amp; validKeys[0] === &quot;All&quot;) {
        // Check if the &quot;All&quot; content contains any internal markers (Research:, Book:, Gen:)
        var containsMarkers = false;
        var lowerAllContent = data[&quot;All&quot;].toLowerCase();
        for (var m = 0; m &lt; BASIS_MARKERS.length; m++) {
            for (var p = 0; p &lt; BASIS_MARKERS[m].patterns.length; p++) {
                if (lowerAllContent.indexOf(BASIS_MARKERS[m].patterns[p]) !== -1) {
                    containsMarkers = true;
                    break;
                }
            }
            if (containsMarkers) break;
        }

        // If it does NOT contain markers, return it as is (default color).
        if (!containsMarkers) {
```

Â  Â  Â  Â  Â  Â      return data["All"];
}
// If it DOES contain markers, we fall through to the combination logic below.
// Note: Applying colors accurately when markers are mixed in a single "All" block is very complex
// without parsing the text entirely. For now, we display it combined but cannot easily color-code
// the segments within a single block in this structure.
Â  Â  Â  Â  }

Â  Â  Â  Â  // If not flattened (or if multiple keys exist), combine all available bases.
Â  Â  Â  Â  var content = [];
Â  Â  Â  Â  validKeys.sort(); // Sort for consistency (e.g., All, Book, Gen, Research)

Â  Â  Â  Â  validKeys.forEach(function(key) {
var color = getBasisColor(key);
Â  Â  Â  Â  Â  Â  Â // Show labels if more than one basis is present
Â  Â  Â  Â  Â  Â  Â if (validKeys.length \> 1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â // Use the first letter of the basis name as the label (A, B, G, R)
Â  Â  Â  Â  Â  Â  Â  Â  Â var label = key.charAt(0).toUpperCase();
// Apply color styling to the whole block including the label
Â  Â  Â  Â  Â  Â  Â  Â  Â content.push('\<span style="color: ' + color + ';"\>\<strong\>[' + label + ']\</strong\> ' + data[key] + '\</span\>');
Â  Â  Â  Â  Â  Â  Â } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â // If only one basis exists (and it wasn't just 'All' caught above), just show the content
// Apply color styling if it's not 'All'
if (key \!== 'All') {
content.push('\<span style="color: ' + color + ';"\>' + data[key] + '\</span\>');
} else {
Â  Â  Â  Â  Â  Â  Â  Â  Â     content.push(data[key]);
}
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  });

Â  Â  Â  Â  var combined = content.join('\\n\\n');
Â  Â  Â  Â  return combined || null;
Â  Â  }

Â  Â  // Populates a specific field in the Overview tab (uses element ID matching the CSV Key)
Â  Â  function populateField(fieldKey, data, basis) {
Â  Â  Â  Â  var element = document.getElementById(fieldKey);
Â  Â  Â  Â  if (element) {
Â  Â  Â  Â  Â  Â  var content = formatData(data[fieldKey], basis);
// Check validity using the helper that strips HTML tags
Â  Â  Â  Â  Â  Â  if (\!isValidContent(content)) {
Â  Â  Â  Â  Â  Â  Â  Â  element.innerHTML = '\<span class="no-data"\>N/A or not available for the selected basis.\</span\>';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  element.innerHTML = content;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // Converts PMC/PMID text into clickable hyperlinks
// UPDATED: Robustly handles inserting links within existing color spans.
Â  Â  function formatReferences(text) {
Â  Â  Â  Â  if (\!text) return text;
Â  Â  Â  Â 
// We use a temporary placeholder to safely apply links within HTML structures (like color spans)
// This prevents regex from accidentally matching HTML attributes or breaking span tags.
var placeholder = 'TEMP\_REF\_PLACEHOLDER\_';
var counter = 0;
var refs = [];

```
    // Function to process content (either raw text or text extracted from a span)
    function processContent(content) {
        // Link PMC IDs
        var linkedContent = content.replace(/(PMC\d+)/g, function(pmcMatch) {
            var refId = placeholder + counter++;
            refs.push({id: refId, url: &quot;https://www.ncbi.nlm.nih.gov/pmc/articles/&quot; + pmcMatch + &quot;/&quot;, label: pmcMatch});
            return refId;
        });

        // Link PMID IDs
        linkedContent = linkedContent.replace(/(PMID\s*[:]?\s*)(\d+)/gi, function(pmidMatch, prefix, id) {
            var refId = placeholder + counter++;
            var label = &#39;PMID:&#39; + id;
            refs.push({id: refId, url: &quot;https://pubmed.ncbi.nlm.nih.gov/&quot; + id + &quot;/&quot;, label: label});
            return refId;
        });
        return linkedContent;
    }

    // Check if the text contains color spans (the most common HTML here)
    var processedText;
    // Use a simple check for the specific span structure we generate
    if (text.indexOf(&#39;&lt;span style=&quot;color:&#39;) !== -1) {
        // If spans exist, extract content, process it, and put it back.
        // This regex matches our generated spans.
        processedText = text.replace(/&lt;span style=&quot;color: (.*?)&quot;&gt;(.*?)&lt;\/span&gt;/g, function(match, color, content) {
            var linkedContent = processContent(content);
            return &#39;&lt;span style=&quot;color: &#39; + color + &#39;&quot;&gt;&#39; + linkedContent + &#39;&lt;/span&gt;&#39;;
        });
    } else {
        // If no spans, process the raw text directly.
        processedText = processContent(text);
    }

    // Replace placeholders with actual links
    refs.forEach(function(ref) {
        // The &lt;a&gt; tag styling is handled by CSS to ensure visibility on different backgrounds.
        processedText = processedText.replace(ref.id, &#39;&lt;a href=&quot;&#39; + ref.url + &#39;&quot; target=&quot;_blank&quot;&gt;&#39; + ref.label + &#39;&lt;/a&gt;&#39;);
    });
```

Â  Â  Â  Â  return processedText;
Â  Â  }
Â  Â Â 
Â  Â  // --- AI Modal Functions ---
Â  Â  function showModal(message, showSpinner, showCloseBtn) {
Â  Â  Â  Â  modalMessage.textContent = message;
Â  Â  Â  Â  modalSpinner.style.display = showSpinner ? 'block' : 'none';
Â  Â  Â  Â  modalCloseBtn.style.display = showCloseBtn ? 'block' : 'none';
Â  Â  Â  Â  aiModal.style.display = 'flex';
Â  Â  }

Â  Â  function hideModal() {
Â  Â  Â  Â  aiModal.style.display = 'none';
Â  Â  }

Â  Â  // --- Gemini API Call Function ---

Â  Â  /\*\*
Â  Â  Â \* Generic function to call the Gemini API with exponential backoff.
Â  Â  Â \* Note: This relies on Fetch API and Promises, which may require polyfills for true ES5 compatibility (e.g., Internet Explorer).
Â  Â  Â \*/
Â  Â  function callGeminiAPI(apiUrl, payload, retries, delay) {
Â  Â  Â  Â  retries = retries === undefined ? 3 : retries;
Â  Â  Â  Â  delay = delay === undefined ? 1000 : delay;

Â  Â  Â  Â  // Basic check for API Key
Â  Â  Â  Â  if (\!API\_KEY || API\_KEY.trim() === "") {
Â  Â  Â  Â  Â  Â  // Ensure Promise exists (for very old browsers, a polyfill might be needed)
Â  Â  Â  Â  Â  Â  if (typeof Promise === 'undefined') {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Promises not supported in this browser.");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return Promise.reject(new Error("API Key is missing."));
Â  Â  Â  Â  }

Â  Â  Â  Â  // Ensure Fetch exists (for very old browsers, a polyfill might be needed)
Â  Â  Â  Â  if (typeof fetch === 'undefined') {
Â  Â  Â  Â  Â  Â  console.error("Fetch API not supported in this browser.");
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  return fetch(apiUrl, {
Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  headers: {
Â  Â  Â  Â  Â  Â  Â  Â  'Content-Type': 'application/json'
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  body: JSON.stringify(payload)
Â  Â  Â  Â  })
Â  Â  Â  Â  .then(function(response) {
Â  Â  Â  Â  Â  Â  if (\!response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  // Try to get more details from the response body
Â  Â  Â  Â  Â  Â  Â  Â  return response.text().then(function(text) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error('HTTP error\! status: ' + response.status + ', Body: ' + text);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return response.json();
Â  Â  Â  Â  })
Â  Â  Â  Â  .catch(function(error) {
Â  Â  Â  Â  Â  Â  console.warn('API call failed. Retries left: ' + retries, error.message);
Â  Â  Â  Â  Â  Â  // Check for specific errors like invalid API key
Â  Â  Â  Â  Â  Â  if (error.message.indexOf("400") \!== -1 || error.message.indexOf("403") \!== -1) {
Â  Â  Â  Â  Â  Â  Â  Â  throw new Error('API call failed: Invalid request or API Key.');
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (retries \> 0) {
Â  Â  Â  Â  Â  Â  Â  Â  return new Promise(function(resolve) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(resolve, delay);
Â  Â  Â  Â  Â  Â  Â  Â  }).then(function() {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return callGeminiAPI(apiUrl, payload, retries - 1, delay \* 2);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  throw new Error('API call failed after all retries: ' + error.message);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  }

Â  Â  // --- Gemini Feature: AI Summary ---

Â  Â  function getAISummary() {
Â  Â  Â  Â  var category = categorySelect.value;
Â  Â  Â  Â  var foodName = foodSelect.value;
Â  Â  Â  Â  if (\!category || \!foodName) return;

Â  Â  Â  Â  var data = foodData[category][foodName];
Â  Â  Â  Â  if (\!data) return;

Â  Â  Â  Â  aiSummaryBtn.disabled = true;
Â  Â  Â  Â  aiSummaryContent.innerHTML = '\<div class="spinner" style="margin: 0;"\>\</div\>\<p style="margin-top: 10px;"\>Generating summary...\</p\>';

Â  Â  Â  Â  var systemPrompt = "You are a friendly and knowledgeable nutritionist. Based on the following raw data about a food, provide a concise, easy-to-read summary (about 2-3 paragraphs) for a layperson. Highlight its main benefits, key nutritional components, and any important usage or safety considerations. Do not just list the data; synthesize it into a coherent summary.";
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Simplify data for the prompt, sending all available basis data
Â  Â  Â  Â  var promptData = {};
Â  Â  Â  Â  for (var key in data) {
Â  Â  Â  Â  Â  Â  if (Object.prototype.hasOwnProperty.call(data, key) && key \!== '\_imageUrl' && data[key]) {
Â  Â  Â  Â  Â  Â  Â  Â  // Use formatData with 'All' to combine all bases for the AI context
Â  Â  Â  Â  Â  Â  Â  Â  var combinedValue = formatData(data[key], 'All');

```
            // CRITICAL: Remove HTML tags (like &lt;span&gt; and &lt;strong&gt;) from the content sent to AI
            if (combinedValue) {
                // Use the safe regex replacement method
                combinedValue = combinedValue.replace(/&lt;[^&gt;]*&gt;/g, &#39;&#39;);
            }
```

Â  Â  Â  Â  Â  Â  Â  Â  if (isValidContent(combinedValue)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // We send the raw key (CSV column name) to the AI.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  promptData[key] = combinedValue;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  var userQuery = "Here is the data for " + foodName + ": \\n" + JSON.stringify(promptData) + "\\n\\n Please provide the summary.";
Â  Â  Â  Â Â 
Â  Â  Â  Â  var payload = {
Â  Â  Â  Â  Â  Â  contents: [{ parts: [{ text: userQuery }] }],
// Include system instruction if the model supports it
...(GEMINI\_TEXT\_MODEL.includes("1.5") && {
Â  Â  Â  Â  Â  Â  systemInstruction: {
Â  Â  Â  Â  Â  Â  Â  Â  parts: [{ text: systemPrompt }]
Â  Â  Â  Â  Â  Â  }
})
Â  Â  Â  Â  };

```
    // Fallback for system prompt if not supported
    if (!payload.systemInstruction) {
        payload.contents[0].parts[0].text = systemPrompt + &quot;\n\n&quot; + userQuery;
    }
```

Â  Â  Â  Â  var apiUrl = 'https://www.google.com/search?q=https://generativelanguage.googleapis.com/v1beta/models/' + GEMINI\_TEXT\_MODEL + ':generateContent?key=' + API\_KEY;

Â  Â  Â  Â  callGeminiAPI(apiUrl, payload)
Â  Â  Â  Â  Â  Â  .then(function(result) {
Â  Â  Â  Â  Â  Â  Â  Â  var text = result.candidates[0].content.parts[0].text;
Â  Â  Â  Â  Â  Â  Â  Â  // Basic Markdown/Text to HTML conversion
Â  Â  Â  Â  Â  Â  Â  Â  aiSummaryContent.innerHTML = text.replace(/\\n/g, '<br>').replace(/\*\*(.\*?)\*\*/g, '\<strong\>$1\</strong\>');
Â  Â  Â  Â  Â  Â  Â  Â  aiSummaryBtn.disabled = false;
Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  .catch(function(error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("AI Summary Error:", error);
Â  Â  Â  Â  Â  Â  Â  Â  aiSummaryContent.innerHTML = '\<p class="no-data" style="color: red;"\>Error generating summary. ' + error.message + '\</p\>';
Â  Â  Â  Â  Â  Â  Â  Â  aiSummaryBtn.disabled = false;
Â  Â  Â  Â  Â  Â  });
Â  Â  }

Â  Â  // --- Gemini Feature: Recipe Idea ---

Â  Â  function getRecipeIdea() {
Â  Â  Â  Â  var foodName = foodSelect.value;
Â  Â  Â  Â  if (\!foodName) return;

Â  Â  Â  Â  var recipeBtn = document.getElementById('ai-recipe-btn');
Â  Â  Â  Â  var recipeContent = document.getElementById('ai-recipe-content');
Â  Â  Â  Â Â 
Â  Â  Â  Â  recipeBtn.disabled = true;
Â  Â  Â  Â  recipeContent.innerHTML = '\<div class="spinner" style="margin: 0;"\>\</div\>\<p style="margin-top: 10px;"\>Generating recipe...\</p\>';

Â  Â  Â  Â  var systemPrompt = "You are a creative and healthy-living chef. You provide simple, healthy recipe ideas in 1-2 paragraphs.";
Â  Â  Â  Â  var userQuery = "Give me a simple, healthy recipe idea that features " + foodName + ".";

Â  Â  Â  Â  var payload = {
Â  Â  Â  Â  Â  Â  contents: [{ parts: [{ text: userQuery }] }],
...(GEMINI\_TEXT\_MODEL.includes("1.5") && {
Â  Â  Â  Â  Â  Â  systemInstruction: {
Â  Â  Â  Â  Â  Â  Â  Â  parts: [{ text: systemPrompt }]
Â  Â  Â  Â  Â  Â  }
})
Â  Â  Â  Â  };

```
    // Fallback for system prompt
    if (!payload.systemInstruction) {
        payload.contents[0].parts[0].text = systemPrompt + &quot;\n\n&quot; + userQuery;
    }
```

Â  Â  Â  Â  var apiUrl = 'https://www.google.com/search?q=https://generativelanguage.googleapis.com/v1beta/models/' + GEMINI\_TEXT\_MODEL + ':generateContent?key=' + API\_KEY;

Â  Â  Â  Â  callGeminiAPI(apiUrl, payload)
Â  Â  Â  Â  Â  Â  .then(function(result) {
Â  Â  Â  Â  Â  Â  Â  Â  var text = result.candidates[0].content.parts[0].text;
Â  Â  Â  Â  Â  Â  Â  Â  recipeContent.innerHTML = text.replace(/\\n/g, '<br>').replace(/\*\*(.\*?)\*\*/g, '\<strong\>$1\</strong\>');
Â  Â  Â  Â  Â  Â  Â  Â  recipeBtn.disabled = false;
Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  .catch(function(error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("AI Recipe Error:", error);
Â  Â  Â  Â  Â  Â  Â  Â  recipeContent.innerHTML = '\<p class="no-data" style="color: red;"\>Error generating recipe. ' + error.message + '\</p\>';
Â  Â  Â  Â  Â  Â  Â  Â  recipeBtn.disabled = false;
Â  Â  Â  Â  Â  Â  });
Â  Â  }

Â  Â  // --- Gemini Feature: Camera Identification ---

Â  Â  function triggerCamera() {
Â  Â  Â  Â  // Check if the button is disabled (due to missing API key or data not loaded)
Â  Â  Â  Â  if (cameraButtonElement && cameraButtonElement.disabled) {
// Provide a more helpful message if disabled
if (\!API\_KEY || API\_KEY.trim() === "") {
Â  Â  Â  Â  Â  Â     showModal("Camera feature is disabled because the Gemini API Key is missing.", false, true);
} else {
showModal("Please wait, data is still loading.", false, true);
}
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  // Click the hidden file input to open the camera or file selector
Â  Â  Â  Â  cameraInput.click();
Â  Â  }

Â  Â  function handleImageUpload(event) {
Â  Â  Â  Â  var file = event.target.files[0];
Â  Â  Â  Â  if (\!file) return;

Â  Â  Â  Â  showModal("Processing image...", true, false);

Â  Â  Â  Â  var reader = new FileReader();
Â  Â  Â  Â  reader.onload = function(e) {
Â  Â  Â  Â  Â  Â  var base64ImageData = e.target.result.split(',')[1]; // Get only the base64 data
Â  Â  Â  Â  Â  Â  var mimeType = file.type || "image/jpeg";
Â  Â  Â  Â  Â  Â  identifyFoodInImage(base64ImageData, mimeType);
Â  Â  Â  Â  };
Â  Â  Â  Â  reader.onerror = function(error) {
Â  Â  Â  Â  Â  Â  console.error("File Reader Error:", error);
Â  Â  Â  Â  Â  Â  showModal("Failed to read image.", false, true);
Â  Â  Â  Â  };
Â  Â  Â  Â  reader.readAsDataURL(file);

Â  Â  Â  Â  // Reset the input value
Â  Â  Â  Â  event.target.value = null;
Â  Â  }

Â  Â  function identifyFoodInImage(base64ImageData, mimeType) {
Â  Â  Â  Â  showModal("Identifying food...", true, false);

Â  Â  Â  Â  var payload = {
Â  Â  Â  Â  Â  Â  contents: [
Â  Â  Â  Â  Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  role: "user",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  parts: [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { text: "Identify the single, most prominent food item in this image. Respond with only the name of the food (e.g., \&quot;Apple\&quot;, \&quot;Banana\&quot;, \&quot;Almonds\&quot;). Do not add any other text or punctuation." },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  inlineData: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mimeType: mimeType,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data: base64ImageData
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ]
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  ],
Â  Â  Â  Â  };

Â  Â  Â  Â  var apiUrl = 'https://www.google.com/search?q=https://generativelanguage.googleapis.com/v1beta/models/' + GEMINI\_VISION\_MODEL + ':generateContent?key=' + API\_KEY;

Â  Â  Â  Â  callGeminiAPI(apiUrl, payload)
Â  Â  Â  Â  Â  Â  .then(function(result) {
Â  Â  Â  Â  Â  Â  Â  Â  var aiFoodName = result.candidates[0].content.parts[0].text;
Â  Â  Â  Â  Â  Â  Â  Â  aiFoodName = aiFoodName.trim().replace(/["."]/g, ''); // Clean up response
Â  Â  Â  Â  Â  Â  Â  Â  findAndSelectFood(aiFoodName);
Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  .catch(function(error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("AI Vision Error:", error);
Â  Â  Â  Â  Â  Â  Â  Â  showModal("Error identifying food. " + error.message, false, true);
Â  Â  Â  Â  Â  Â  });
Â  Â  }

```
// --- Robust Matching Logic ---
// This section implements the &quot;robust API-free logic&quot; for matching identified names to the database.

// NEW: Helper function for robust matching: Normalizes text
function normalizeText(text) {
    if (!text) return &quot;&quot;;
    // Lowercase, remove punctuation (except hyphens within words), trim
    // We use a regex compatible with older JS: replace characters that are NOT a-z, 0-9, space, or hyphen.
    var normalized = text.toLowerCase().replace(/[^a-z0-9\s-]/g, &#39;&#39;).trim();
    
    // Simple plural handling (very basic normalization)
    // This helps match &quot;Almonds&quot; to &quot;Almond&quot; or vice versa.
    if (normalized.endsWith(&#39;s&#39;) &amp;&amp; normalized.length &gt; 3) {
        // Remove the &#39;s&#39; but return both versions for better matching potential
        return [normalized, normalized.substring(0, normalized.length - 1)];
    }
    return [normalized];
}

// NEW: Helper function for robust matching: Calculates match score between normalized arrays
function calculateMatchScore(aiNamesNorm, dbNameNorm) {
    var bestScore = 0;

    // Iterate over potential variations (e.g., plural/singular)
    aiNamesNorm.forEach(function(aiName) {
        var score = 0;
        if (aiName === dbNameNorm) {
            score = 100; // Perfect match
        } else if (aiName.indexOf(dbNameNorm) !== -1 || dbNameNorm.indexOf(aiName) !== -1) {
            // Check containment (e.g., &quot;Salmon&quot; vs &quot;Wild Salmon&quot;)
            // Penalize if the difference in length is large (e.g. &quot;Nut&quot; matching &quot;Peanut Butter&quot;)
            var lengthDiff = Math.abs(aiName.length - dbNameNorm.length);
            score = 90 - (lengthDiff * 2); // Heuristic penalty for length difference
        } else {
            // Token matching (handles different word orders or extra words)
            var aiTokens = aiName.split(/\s+/);
            var dbTokens = dbNameNorm.split(/\s+/);
            var matches = 0;
            aiTokens.forEach(function(token) {
                if (dbTokens.indexOf(token) !== -1) {
                    matches++;
                }
            });

            // Calculate percentage of tokens matched
            score = (matches / Math.max(aiTokens.length, dbTokens.length)) * 80;
        }

        if (score &gt; bestScore) {
            bestScore = score;
        }
    });
    
    return bestScore;
}


// REVISED: Uses scoring and normalization for more robust matching
```

Â  Â  function findAndSelectFood(aiFoodName) {
// Normalize the AI name (returns an array of possibilities)
Â  Â  Â  Â  var aiNamesNorm = normalizeText(aiFoodName);

```
    var bestMatch = {
        category: null,
        food: null,
        score: 0
    };
    
    // Define a minimum threshold for matching
    var MIN_SCORE_THRESHOLD = 60; 
```

Â  Â  Â  Â  // Loop through all categories and foods to find the best match
Â  Â  Â  Â  for (var category in foodData) {
Â  Â  Â  Â  Â  Â  if (Object.prototype.hasOwnProperty.call(foodData, category)) {
Â  Â  Â  Â  Â  Â  Â  Â  for (var food in foodData[category]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (Object.prototype.hasOwnProperty.call(foodData[category], food)) {

```
                    // Clean the database name (remove content in parentheses first)
                    var dbNameClean = food.replace(/\(.*?\)/g, &#39;&#39;).trim();
                    // Normalize the database name (we only take the first element as we want the primary name)
```

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  var dbNameNorm = normalizeText(dbNameClean)[0];

```
                    // Calculate score between AI possibilities and the database name
                    var score = calculateMatchScore(aiNamesNorm, dbNameNorm);
```

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (score \> bestMatch.score) {
bestMatch.score = score;
bestMatch.category = category;
bestMatch.food = food;
}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  if (bestMatch.category && bestMatch.score \>= MIN\_SCORE\_THRESHOLD) {
var matchedFood = bestMatch.food;
var matchedCategory = bestMatch.category;

```
        // Display the match confidence to the user
```

Â  Â  Â  Â  Â  Â  showModal("Found: " + matchedFood + "\!\\n(Confidence: " + Math.round(bestMatch.score) + "%)", true, false);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Set category
Â  Â  Â  Â  Â  Â  categorySelect.value = matchedCategory;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Manually trigger the 'change' event
Â  Â  Â  Â  Â  Â  var event;
Â  Â  Â  Â  Â  Â  if (typeof(Event) === 'function') {
Â  Â  Â  Â  Â  Â  Â  Â  event = new Event('change');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // Fallback for older browsers
Â  Â  Â  Â  Â  Â  Â  Â  event = document.createEvent('Event');
Â  Â  Â  Â  Â  Â  Â  Â  event.initEvent('change', true, true);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  categorySelect.dispatchEvent(event);

Â  Â  Â  Â  Â  Â  // Set food (must happen *after* the food list is populated)
Â  Â  Â  Â  Â  Â  foodSelect.value = matchedFood;

Â  Â  Â  Â  Â  Â  // Update the display
Â  Â  Â  Â  Â  Â  foodSelect.dispatchEvent(event);
Â  Â  Â  Â  Â  Â Â 
// Extended time to allow user to see the confidence score
Â  Â  Â  Â  Â  Â  setTimeout(hideModal, 2000);
Â  Â  Â  Â  } else {
// Improved feedback when match fails, showing the closest option if one exists
var message = "AI identified: " + aiFoodName + ".\\nNot found or low confidence match in our database.";
if (bestMatch.category) {
message += "\\n(Closest match: " + bestMatch.food + ", Confidence: " + Math.round(bestMatch.score) + "%)";
}
Â  Â  Â  Â  Â  Â  showModal(message, false, true);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // Initialize the application by fetching data
Â  Â  fetchAndProcessData();

\</script\>

\</body\>
\</html\>
